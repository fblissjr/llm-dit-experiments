<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z-Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Loading animation */
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Smooth transitions */
        .panel-transition { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* History thumbnail hover */
        .history-item:hover .history-overlay { opacity: 1; }
        .history-overlay { transition: opacity 0.2s ease; }

        /* Mobile bottom sheet */
        @media (max-width: 768px) {
            .history-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 60vh;
                border-radius: 1rem 1rem 0 0;
                z-index: 50;
            }
            .history-panel.collapsed {
                max-height: 48px;
            }
        }

        /* Prevent body scroll when panel open on mobile */
        body.panel-open { overflow: hidden; }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            button, select, input[type="number"] {
                min-height: 44px;
            }
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            margin-top: -0.375rem;
        }

        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            border: none;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-6 pb-20 md:pb-6 overflow-y-auto">
            <!-- Header -->
            <header class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white" id="headerTitle">Z-Image</h1>
                        <p class="text-sm text-gray-400" id="headerSubtitle">Text-to-image with Qwen3-4B</p>
                    </div>
                    <button
                        id="historyToggle"
                        class="md:hidden p-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700"
                        aria-label="Toggle history"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Model Type Selector -->
            <div class="mb-6 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                <label class="block text-sm font-medium text-gray-300 mb-3">Model</label>
                <div class="flex gap-2">
                    <button type="button" id="modelTypeZImage" class="flex-1 px-4 py-2.5 rounded-lg bg-blue-600 text-white font-medium transition-colors">
                        Z-Image
                        <span class="block text-xs font-normal opacity-75">Text-to-Image</span>
                    </button>
                    <button type="button" id="modelTypeQwenImage" class="flex-1 px-4 py-2.5 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 font-medium transition-colors">
                        Qwen-Image
                        <span class="block text-xs font-normal opacity-75">Image Decomposition</span>
                    </button>
                </div>
                <p id="qwenImageStatus" class="hidden text-xs text-yellow-400 mt-2">Qwen-Image not configured. Set qwen_image.model_path in config.</p>
            </div>

            <!-- Qwen-Image Controls (hidden by default, shown when Qwen-Image selected) -->
            <div id="qwenImageControls" class="hidden mb-6 space-y-4">
                <!-- Input Image (required for Qwen-Image) -->
                <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Input Image *</label>
                    <div id="qiDropzone" class="relative border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-purple-500 hover:bg-gray-800/50 transition-colors">
                        <input type="file" id="qiImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="qiDropzoneContent">
                            <svg class="w-8 h-8 mx-auto text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-sm text-gray-400">Drop image here or click to upload</p>
                            <p class="text-xs text-gray-500 mt-1">Image will be resized to 640x640 or 1024x1024</p>
                        </div>
                        <!-- Image Preview -->
                        <div id="qiImagePreview" class="hidden">
                            <img id="qiPreviewImg" class="max-h-32 mx-auto rounded-lg" alt="Input image">
                            <p id="qiImageInfo" class="text-xs text-gray-400 mt-2"></p>
                        </div>
                    </div>
                    <button type="button" id="qiClearImage" class="hidden mt-2 text-xs text-red-400 hover:text-red-300">Clear image</button>
                </div>

                <!-- Prompt for Qwen-Image -->
                <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                    <label for="qiPrompt" class="block text-sm font-medium text-gray-300 mb-2">Scene Description *</label>
                    <textarea
                        id="qiPrompt"
                        rows="3"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                        placeholder="Describe the scene to decompose (e.g., 'A cheerful child waving under a blue sky')"
                    ></textarea>
                </div>

                <!-- Qwen-Image Parameters -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Resolution -->
                    <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolution</label>
                        <select id="qiResolution" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 text-sm">
                            <option value="1024">1024 x 1024</option>
                            <option value="640">640 x 640</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Fixed resolutions only</p>
                    </div>

                    <!-- Layers -->
                    <div class="p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Layers: <span id="qiLayersValue" class="text-purple-400">3</span>
                        </label>
                        <input type="range" id="qiLayers" min="1" max="7" value="3" class="w-full">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1</span>
                            <span>7</span>
                        </div>
                    </div>
                </div>

                <!-- Advanced Parameters -->
                <details class="group">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Advanced Parameters
                    </summary>
                    <div class="mt-3 grid grid-cols-2 gap-3 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- CFG Scale -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                CFG Scale: <span id="qiCfgValue" class="text-purple-400">4.0</span>
                            </label>
                            <input type="range" id="qiCfgScale" min="1" max="10" step="0.5" value="4.0" class="w-full">
                        </div>

                        <!-- Steps -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Steps: <span id="qiStepsValue" class="text-purple-400">30</span>
                            </label>
                            <input type="range" id="qiSteps" min="10" max="50" value="30" class="w-full">
                        </div>

                        <!-- Seed -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Seed (optional)</label>
                            <input type="number" id="qiSeed" placeholder="Random" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 text-sm">
                        </div>
                    </div>
                </details>

                <!-- Decompose Button -->
                <button
                    type="button"
                    id="decomposeBtn"
                    class="w-full py-4 px-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors text-lg shadow-lg shadow-purple-500/20"
                >
                    Decompose Image
                </button>

                <!-- Decompose Status -->
                <div id="qiStatus" class="hidden">
                    <div class="bg-gray-800 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                            <span id="qiStatusText" class="text-gray-300">Decomposing...</span>
                        </div>
                        <div class="mt-3 h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div id="qiProgressFill" class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Decompose Error -->
                <div id="qiError" class="hidden">
                    <div class="bg-red-900/30 border border-red-700/50 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-red-300 text-sm" id="qiErrorText"></p>
                        </div>
                    </div>
                </div>

                <!-- Decompose Result -->
                <div id="qiResult" class="hidden">
                    <div class="bg-gray-800 rounded-xl overflow-hidden p-4">
                        <h3 class="text-sm font-medium text-gray-300 mb-3">Decomposed Layers</h3>
                        <p class="text-xs text-gray-500 mb-3">Click "Edit" on any layer to modify it with text instructions</p>
                        <div id="qiLayerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            <!-- Layers will be added dynamically -->
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <p id="qiResultInfo" class="text-xs text-gray-400"></p>
                            <button type="button" id="qiDownloadZip" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                                Download ZIP
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Layer Edit Modal -->
                <div id="qiEditModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                    <div class="bg-gray-900 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-700">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">Edit Layer</h3>
                                <button type="button" id="qiEditClose" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Original Layer Preview -->
                            <div class="mb-4">
                                <p class="text-sm text-gray-400 mb-2">Original Layer: <span id="qiEditLayerName" class="text-purple-400"></span></p>
                                <div class="bg-gray-800 rounded-lg p-2 inline-block">
                                    <img id="qiEditOriginalImg" class="max-h-40 rounded bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImNoZWNrIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxyZWN0IHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIgZmlsbD0iIzMzMyIvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjMzMzIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCBmaWxsPSJ1cmwoI2NoZWNrKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==')]" alt="Original layer">
                                </div>
                            </div>

                            <!-- Edit Instruction -->
                            <div class="mb-4">
                                <label for="qiEditInstruction" class="block text-sm font-medium text-gray-300 mb-2">Edit Instruction</label>
                                <textarea
                                    id="qiEditInstruction"
                                    rows="2"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                    placeholder="Describe how to modify this layer (e.g., 'Change the color to blue', 'Add a pattern')"
                                ></textarea>
                            </div>

                            <!-- Edit Parameters (collapsible) -->
                            <details class="mb-4 group">
                                <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                                    <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    Advanced Parameters
                                </summary>
                                <div class="mt-3 grid grid-cols-2 gap-3 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            CFG Scale: <span id="qiEditCfgValue" class="text-purple-400">4.0</span>
                                        </label>
                                        <input type="range" id="qiEditCfgScale" min="1" max="10" step="0.5" value="4.0" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            Steps: <span id="qiEditStepsValue" class="text-purple-400">50</span>
                                        </label>
                                        <input type="range" id="qiEditSteps" min="20" max="100" value="50" class="w-full">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Seed (optional)</label>
                                        <input type="number" id="qiEditSeed" placeholder="Random" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-purple-500 text-sm">
                                    </div>
                                </div>
                            </details>

                            <!-- Edit Button -->
                            <button
                                type="button"
                                id="qiEditBtn"
                                class="w-full py-3 px-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors shadow-lg shadow-purple-500/20"
                            >
                                Apply Edit
                            </button>

                            <!-- Edit Status -->
                            <div id="qiEditStatus" class="hidden mt-4">
                                <div class="bg-gray-800 rounded-xl p-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span id="qiEditStatusText" class="text-gray-300">Editing layer...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Edit Error -->
                            <div id="qiEditError" class="hidden mt-4">
                                <div class="bg-red-900/30 border border-red-700/50 rounded-xl p-4">
                                    <p class="text-red-300 text-sm" id="qiEditErrorText"></p>
                                </div>
                            </div>

                            <!-- Edit Result -->
                            <div id="qiEditResult" class="hidden mt-4">
                                <p class="text-sm text-gray-400 mb-2">Edited Result:</p>
                                <div class="bg-gray-800 rounded-lg p-2 inline-block mb-4">
                                    <img id="qiEditResultImg" class="max-h-48 rounded bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImNoZWNrIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxyZWN0IHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIgZmlsbD0iIzMzMyIvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjMzMzIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCBmaWxsPSJ1cmwoI2NoZWNrKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==')]" alt="Edited layer">
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" id="qiEditReplace" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                                        Replace Original
                                    </button>
                                    <button type="button" id="qiEditDownload" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Z-Image Controls (shown by default) -->
            <div id="zImageControls">
            <!-- Main Form -->
            <form id="generateForm" class="space-y-4" novalidate>
                <!-- Prompt -->
                <div>
                    <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Prompt *</label>
                    <textarea
                        id="prompt"
                        rows="6"
                        required
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Describe what you want to generate..."
                    ></textarea>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500">Token count updates when you stop typing</p>
                        <p id="tokenCount" class="text-xs text-gray-400">-- / 1504 tokens</p>
                    </div>
                </div>

                <!-- Template -->
                <div>
                    <label for="template" class="block text-sm font-medium text-gray-300 mb-2">Template</label>
                    <select id="template" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">None</option>
                    </select>
                </div>

                <!-- Prompt Rewriter (collapsible) -->
                <details class="group" id="rewriterSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Prompt Rewriter (Qwen3)
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-400">Use the loaded Qwen3 model to expand or rewrite your prompt</p>

                        <!-- Mode Toggle -->
                        <div class="flex gap-2">
                            <button type="button" id="rewriterModeTemplate" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white">Template</button>
                            <button type="button" id="rewriterModeCustom" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">Custom</button>
                        </div>

                        <!-- Model Selector -->
                        <div id="rewriterModelContainer">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                            <select id="rewriterModel" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="qwen3-4b">Qwen3-4B (Text)</option>
                                <!-- VL option added dynamically if available -->
                            </select>
                        </div>

                        <!-- VL Image Upload (hidden by default, shown when VL model selected) -->
                        <div id="rewriterImageUpload" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Reference Image <span class="text-gray-500">(optional)</span></label>
                            <div id="rewriterDropzone" class="relative border-2 border-dashed border-gray-600 rounded-lg p-3 text-center cursor-pointer hover:border-purple-500 hover:bg-gray-800/50 transition-colors">
                                <input type="file" id="rewriterImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <div id="rewriterDropzoneContent">
                                    <svg class="w-6 h-6 mx-auto text-gray-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-xs text-gray-400">Drop image or click to upload</p>
                                </div>
                                <!-- Image Preview -->
                                <div id="rewriterImagePreview" class="hidden">
                                    <img id="rewriterPreviewImg" class="max-h-20 mx-auto rounded-lg" alt="Rewriter reference image">
                                    <button type="button" id="rewriterClearImage" class="mt-2 text-xs text-red-400 hover:text-red-300">Clear</button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Use an image as input for VL rewriting</p>
                        </div>

                        <!-- Template Mode -->
                        <div id="rewriterTemplateMode">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewriter Style</label>
                            <select id="rewriterTemplate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">Select a rewriter...</option>
                            </select>
                        </div>

                        <!-- Custom Mode -->
                        <div id="rewriterCustomMode" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custom Instructions</label>
                            <textarea id="customRewriterPrompt" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="Write your own rewriting instructions...&#10;&#10;Example: Expand this into a detailed image description with cinematic lighting and moody atmosphere."></textarea>
                        </div>

                        <!-- Rewriter Controls -->
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Max Tokens</label>
                                <input type="number" id="rewriterMaxTokens" value="512" min="64" max="2048" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Temperature</label>
                                <input type="number" id="rewriterTemperature" value="0.6" min="0" max="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Top P</label>
                                <input type="number" id="rewriterTopP" value="0.95" min="0" max="1" step="0.05" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Top K</label>
                                <input type="number" id="rewriterTopK" value="20" min="0" max="100" step="1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Min P</label>
                                <input type="number" id="rewriterMinP" value="0.0" min="0" max="1" step="0.05" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Presence Pen.</label>
                                <input type="number" id="rewriterPresencePenalty" value="0.0" min="0" max="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Rewrite Button -->
                        <button
                            type="button"
                            id="rewriteBtn"
                            class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors text-sm"
                        >
                            Rewrite Prompt
                        </button>

                        <!-- Rewrite Status -->
                        <div id="rewriteStatus" class="hidden">
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <div class="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                <span>Rewriting...</span>
                            </div>
                        </div>

                        <!-- Rewritten Result -->
                        <div id="rewrittenResult" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewritten Prompt</label>
                            <div class="bg-gray-900 rounded-lg p-3 max-h-48 overflow-y-auto">
                                <pre class="text-xs text-gray-300 whitespace-pre-wrap font-mono" id="rewrittenText"></pre>
                            </div>
                            <!-- Extracted Thinking Content -->
                            <div id="extractedThinkingResult" class="hidden mt-3">
                                <label class="block text-sm font-medium text-purple-400 mb-2">Extracted Thinking Content</label>
                                <div class="bg-purple-900/30 border border-purple-700 rounded-lg p-3 max-h-32 overflow-y-auto">
                                    <pre class="text-xs text-purple-300 whitespace-pre-wrap font-mono" id="extractedThinkingText"></pre>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button
                                    type="button"
                                    id="useRewrittenBtn"
                                    class="flex-1 py-2 px-3 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Use This Prompt
                                </button>
                                <button
                                    type="button"
                                    id="copyRewrittenBtn"
                                    class="py-2 px-3 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Copy to clipboard"
                                >
                                    Copy
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="rewriteInfo"></p>
                        </div>
                    </div>
                </details>

                <!-- Vision Conditioning (Qwen3-VL) - collapsible -->
                <details class="group" id="vlSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Vision Conditioning (Qwen3-VL)
                        <span id="vlStatusBadge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">Checking...</span>
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-400">Use a reference image to influence the generated style/content</p>

                        <!-- VL Not Available Warning -->
                        <div id="vlNotAvailable" class="hidden bg-yellow-900/30 border border-yellow-700 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">Qwen3-VL not configured. Set vl.model_path in config.toml to enable vision conditioning.</p>
                        </div>

                        <!-- VL Controls (shown when available) -->
                        <div id="vlControls">
                            <!-- Image Upload -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Reference Image</label>
                                <div id="vlDropzone" class="relative border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-800/50 transition-colors">
                                    <input type="file" id="vlImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                    <div id="vlDropzoneContent">
                                        <svg class="w-8 h-8 mx-auto text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <p class="text-sm text-gray-400">Drop image here or click to upload</p>
                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 2048x2048</p>
                                    </div>
                                    <!-- Image Preview (hidden by default) -->
                                    <div id="vlImagePreview" class="hidden">
                                        <img id="vlPreviewImg" class="max-h-32 mx-auto rounded-lg" alt="Reference image">
                                        <p id="vlImageInfo" class="text-xs text-gray-400 mt-2"></p>
                                    </div>
                                </div>
                                <button type="button" id="vlClearImage" class="hidden mt-2 text-xs text-red-400 hover:text-red-300">Clear image</button>
                            </div>

                            <!-- Alpha Slider -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    VL Influence: <span id="vlAlphaValue" class="text-blue-400">0.3</span>
                                </label>
                                <input type="range" id="vlAlpha" min="0" max="1" step="0.05" value="0.3" class="w-full">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0.0 (Text only)</span>
                                    <span>1.0 (VL only)</span>
                                </div>
                            </div>

                            <!-- Presets -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Presets</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button type="button" data-alpha="0.2" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                        Style (0.2)
                                    </button>
                                    <button type="button" data-alpha="0.3" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-blue-600 text-white transition-colors">
                                        Balanced (0.3)
                                    </button>
                                    <button type="button" data-alpha="0.5" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                        Strong (0.5)
                                    </button>
                                </div>
                            </div>

                            <!-- Blend Mode -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Blend Mode</label>
                                <select id="vlBlendMode" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="linear">Linear (default)</option>
                                    <option value="style_only">Style Only (preserves text content)</option>
                                    <option value="graduated">Graduated (more VL for later tokens)</option>
                                    <option value="attention_weighted">Attention Weighted (experimental)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Linear blends uniformly. Style Only preserves subject/content from text.</p>
                            </div>

                            <!-- Advanced Options -->
                            <details class="group/vl-adv">
                                <summary class="cursor-pointer text-xs font-medium text-gray-500 hover:text-gray-400 flex items-center gap-1 select-none">
                                    <svg class="w-3 h-3 transition-transform group-open/vl-adv:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    Advanced Options
                                </summary>
                                <div class="mt-3 space-y-3 pl-4 border-l border-gray-700">
                                    <!-- Hidden Layer -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1">
                                            VL Hidden Layer: <span id="vlHiddenLayerValue" class="text-blue-400">-2</span>
                                        </label>
                                        <input type="range" id="vlHiddenLayer" min="-6" max="-1" value="-2" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>-6 (Early)</span>
                                            <span>-1 (Last)</span>
                                        </div>
                                    </div>

                                    <!-- Image Tokens Only -->
                                    <div class="flex items-center">
                                        <input type="checkbox" id="vlImageTokensOnly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2">
                                        <label for="vlImageTokensOnly" class="ml-2 text-xs text-gray-400">Image tokens only</label>
                                    </div>

                                    <!-- VL Text Description -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1">VL Text (optional)</label>
                                        <input type="text" id="vlText" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-xs focus:ring-2 focus:ring-blue-500" placeholder="Description with reference image">
                                        <p class="text-xs text-gray-500 mt-1">Text to process along with the image</p>
                                    </div>
                                </div>
                            </details>

                            <!-- Extract Status -->
                            <div id="vlExtractStatus" class="hidden mt-3">
                                <div class="flex items-center gap-2 text-sm text-gray-400">
                                    <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span>Extracting VL embeddings...</span>
                                </div>
                            </div>

                            <!-- Extracted Embeddings Info -->
                            <div id="vlExtractedInfo" class="hidden mt-3 bg-green-900/20 border border-green-700 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-green-400 font-medium">Embeddings Ready</p>
                                        <p id="vlExtractedDetails" class="text-xs text-gray-400 mt-1"></p>
                                    </div>
                                    <button type="button" id="vlClearEmbeddings" class="text-xs text-red-400 hover:text-red-300">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Resolution & Steps Row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Resolution Preset -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolution</label>
                        <select id="resolution" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                            <optgroup label="Square">
                                <option value="512x512">512 x 512</option>
                                <option value="768x768">768 x 768</option>
                                <option value="1024x1024" selected>1024 x 1024</option>
                                <option value="1280x1280">1280 x 1280</option>
                                <option value="1536x1536">1536 x 1536</option>
                                <option value="1920x1920">1920 x 1920</option>
                            </optgroup>
                            <optgroup label="Landscape (16:9)">
                                <option value="1280x720">1280 x 720 (HD)</option>
                                <option value="1920x1088">1920 x 1088 (Full HD)</option>
                            </optgroup>
                            <optgroup label="Portrait (9:16)">
                                <option value="720x1280">720 x 1280 (HD)</option>
                                <option value="1088x1920">1088 x 1920 (Full HD)</option>
                            </optgroup>
                            <optgroup label="Mobile Landscape">
                                <option value="1024x576">1024 x 576</option>
                                <option value="1280x576">1280 x 576 (Wide)</option>
                            </optgroup>
                            <optgroup label="Mobile Portrait">
                                <option value="576x1024">576 x 1024</option>
                                <option value="576x1280">576 x 1280 (Tall)</option>
                            </optgroup>
                            <optgroup label="Classic (4:3 / 3:4)">
                                <option value="1024x768">1024 x 768 (Landscape)</option>
                                <option value="768x1024">768 x 1024 (Portrait)</option>
                                <option value="1280x960">1280 x 960 (Landscape)</option>
                                <option value="960x1280">960 x 1280 (Portrait)</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Steps -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Steps: <span id="stepsValue" class="text-blue-400">9</span>
                        </label>
                        <input
                            type="range"
                            id="steps"
                            min="1"
                            max="50"
                            value="9"
                            class="w-full mt-1"
                        >
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 (Fast)</span>
                            <span>50 (Quality)</span>
                        </div>
                    </div>
                </div>

                <!-- Seed -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Seed (optional)</label>
                    <input
                        type="number"
                        id="seed"
                        placeholder="Random"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Leave empty for random seed</p>
                </div>

                <!-- Advanced Options (collapsible) -->
                <details class="group" open>
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Chat Template Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- System Prompt -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">System Prompt</label>
                            <textarea
                                id="systemPrompt"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="You are a painter. (optional)"
                            ></textarea>
                        </div>

                        <!-- Strip Quotes -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="stripQuotes"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="stripQuotes" class="ml-2 text-sm text-gray-300">Strip quotes from prompt</label>
                            <span class="ml-2 text-xs text-gray-500">(for JSON-type prompts)</span>
                        </div>

                        <!-- Add Think Block -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="enableThinking"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="enableThinking" class="ml-2 text-sm text-gray-300">Add think block</label>
                            <span class="ml-2 text-xs text-gray-500">(default: off, matching HF Space)</span>
                        </div>

                        <!-- Thinking Content (shown when think block enabled) -->
                        <div id="thinkingContentWrapper" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Thinking Content</label>
                            <textarea
                                id="thinkingContent"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="Content inside <think>...</think> (optional)"
                            ></textarea>
                        </div>

                        <!-- Assistant Content -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Assistant Content</label>
                            <input
                                type="text"
                                id="assistantContent"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="Here is your image: (optional)"
                            >
                        </div>
                    </div>
                </details>

                <!-- Scheduler Options (collapsible) -->
                <details class="group" open>
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Scheduler Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- Guidance Scale -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Guidance Scale: <span id="guidanceScaleValue" class="text-blue-400">0.0</span>
                            </label>
                            <input
                                type="range"
                                id="guidanceScale"
                                min="0"
                                max="10"
                                step="0.1"
                                value="0.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.0 (Default for Z-Image Turbo)</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Z-Image Turbo uses 0.0 (CFG baked in via Decoupled-DMD)</p>
                        </div>

                        <!-- Shift -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Scheduler Shift: <span id="shiftValue" class="text-blue-400">3.0</span>
                            </label>
                            <input
                                type="range"
                                id="shift"
                                min="0.5"
                                max="10.0"
                                step="0.1"
                                value="3.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.5</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">FlowMatchEuler scheduler shift parameter (default: 3.0)</p>
                        </div>

                        <!-- Long Prompt Mode -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Long Prompt Mode</label>
                            <select id="longPromptMode" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="truncate">Truncate (cuts off end)</option>
                                <option value="interpolate" selected>Interpolate (default, smooth resampling)</option>
                                <option value="pool">Pool (local averaging)</option>
                                <option value="attention_pool">Attention Pool (preserve important)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How to handle prompts exceeding 1504 tokens</p>
                        </div>

                        <!-- Hidden Layer -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Hidden Layer: <span id="hiddenLayerValue" class="text-blue-400">-2</span>
                                <span id="hiddenLayerLabel" class="text-gray-500 text-xs ml-1">(Layer 35 of 36)</span>
                            </label>

                            <!-- Layer Presets - Touch-friendly buttons -->
                            <div class="grid grid-cols-4 gap-1.5 mb-3">
                                <button type="button" data-layer="-2" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-blue-600 text-white transition-colors">
                                    -2
                                </button>
                                <button type="button" data-layer="-4" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -4
                                </button>
                                <button type="button" data-layer="-6" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -6
                                </button>
                                <button type="button" data-layer="-10" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -10
                                </button>
                                <button type="button" data-layer="-14" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -14
                                </button>
                                <button type="button" data-layer="-18" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -18
                                </button>
                                <button type="button" data-layer="-24" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -24
                                </button>
                                <button type="button" data-layer="-30" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -30
                                </button>
                            </div>

                            <!-- Visual Layer Position Indicator -->
                            <div class="relative mb-2">
                                <!-- Layer track - simple gradient from early to late -->
                                <div class="h-5 rounded-lg bg-gradient-to-r from-gray-700 via-gray-600 to-gray-500 relative">
                                    <!-- Layer markers -->
                                    <div class="absolute inset-0 flex justify-between items-center px-1 text-xs text-gray-400">
                                        <span>1</span>
                                        <span>9</span>
                                        <span>18</span>
                                        <span>27</span>
                                        <span>36</span>
                                    </div>
                                </div>
                                <!-- Position indicator -->
                                <div id="layerPositionIndicator" class="absolute top-0 w-1.5 h-5 bg-blue-400 rounded shadow-lg transition-all duration-150" style="left: 94.3%;"></div>
                            </div>

                            <!-- Full Range Slider -->
                            <input type="range" id="hiddenLayer" min="-35" max="-1" value="-2" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>-35 (Layer 1)</span>
                                <span>-1 (Layer 36)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Default is -2. Qwen3-4B has 36 layers total.
                            </p>
                        </div>

                    </div>
                </details>

                <!-- DyPE High-Resolution Options (collapsible) -->
                <details class="group" id="dypeSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        DyPE (High-Resolution)
                        <span id="dypeStatusBadge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">Off</span>
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- Enable DyPE -->
                        <div class="flex items-center gap-3">
                            <label for="dypeEnabled" class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="dypeEnabled" class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-300">Enable DyPE</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500">Dynamic Position Extrapolation for 2K+ resolution generation. Adjusts RoPE frequencies based on diffusion timestep.</p>

                        <!-- DyPE Method -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Method</label>
                            <select id="dypeMethod" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="vision_yarn" selected>Vision YaRN (Recommended)</option>
                                <option value="yarn">YaRN</option>
                                <option value="ntk">NTK</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Vision YaRN uses dual-mask frequency blending for best quality</p>
                        </div>

                        <!-- Multipass Mode -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Generation Mode</label>
                            <select id="dypeMultipass" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="single">Single Pass</option>
                                <option value="twopass" selected>Two Pass (Recommended for 4K)</option>
                                <option value="threepass">Three Pass (Ultra Quality)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Two-pass: 1/2 res txt2img, then full res img2img. Better stability at 4K+.</p>
                        </div>

                        <!-- Advanced DyPE Options (collapsible) -->
                        <details class="group/dype-adv">
                            <summary class="cursor-pointer text-xs font-medium text-gray-500 hover:text-gray-400 flex items-center gap-1 select-none">
                                <svg class="w-3 h-3 transition-transform group-open/dype-adv:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                Advanced Options
                            </summary>
                            <div class="mt-3 space-y-4 pl-4 border-l border-gray-700">
                                <!-- DyPE Scale -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        DyPE Scale: <span id="dypeScaleValue" class="text-blue-400">2.0</span>
                                    </label>
                                    <input type="range" id="dypeScale" min="0.5" max="4.0" step="0.1" value="2.0" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>0.5 (Subtle)</span>
                                        <span>4.0 (Aggressive)</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Magnitude of DyPE effect (lambda_s)</p>
                                </div>

                                <!-- DyPE Exponent -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        DyPE Exponent: <span id="dypeExponentValue" class="text-blue-400">2.0</span>
                                    </label>
                                    <input type="range" id="dypeExponent" min="1.0" max="4.0" step="0.1" value="2.0" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>1.0 (Linear)</span>
                                        <span>4.0 (Sharp)</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Decay speed of DyPE (lambda_t). 2.0 = quadratic decay.</p>
                                </div>

                                <!-- Base/Max Shift -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            Base Shift: <span id="dypeBaseShiftValue" class="text-blue-400">0.5</span>
                                        </label>
                                        <input type="range" id="dypeBaseShift" min="0.1" max="1.0" step="0.05" value="0.5" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            Max Shift: <span id="dypeMaxShiftValue" class="text-blue-400">1.15</span>
                                        </label>
                                        <input type="range" id="dypeMaxShift" min="0.5" max="2.0" step="0.05" value="1.15" class="w-full">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500">Noise schedule shift at base (1024px) and max resolution.</p>

                                <!-- Second Pass Strength (for multipass) -->
                                <div id="dypeStrengthContainer">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Pass 2 Strength: <span id="dypeStrengthValue" class="text-blue-400">0.5</span>
                                    </label>
                                    <input type="range" id="dypeStrength" min="0.3" max="0.8" step="0.05" value="0.5" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>0.3 (Light Refinement)</span>
                                        <span>0.8 (Strong)</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">img2img strength for second pass. Lower = more detail preservation.</p>
                                </div>
                            </div>
                        </details>
                    </div>
                </details>

                <!-- SLG (Skip Layer Guidance) Options (collapsible) -->
                <details class="group" id="slgSection">
                    <summary class="flex items-center gap-2 text-sm font-medium text-gray-300 cursor-pointer py-2 select-none">
                        <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        SLG (Skip Layer Guidance)
                        <span id="slgStatusBadge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">Off</span>
                    </summary>
                    <div class="pt-2 pb-1 space-y-4 pl-5 border-l-2 border-gray-700/50 ml-1.5">
                        <p class="text-xs text-gray-500">Improves structure and anatomy for humans/animals. Requires ~2x inference time.</p>

                        <!-- Enable SLG -->
                        <div>
                            <label for="slgEnabled" class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="slgEnabled" class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-300">Enable SLG</span>
                            </label>
                        </div>

                        <!-- SLG Scale -->
                        <div id="slgScaleContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Scale: <span id="slgScaleValue" class="text-blue-400">2.5</span>
                            </label>
                            <input type="range" id="slgScale" min="1.0" max="4.0" step="0.1" value="2.5" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>1.0 (Subtle)</span>
                                <span>4.0 (Strong)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Guidance strength. 2.0-3.0 typical for turbo models. Higher may cause artifacts.</p>
                        </div>

                        <!-- SLG Layers -->
                        <div id="slgLayersContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Layers: <span id="slgLayersValue" class="text-blue-400">7-12</span>
                            </label>
                            <select id="slgLayers" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="7,8,9,10,11,12">Middle (7-12) - Recommended</option>
                                <option value="5,6,7,8,9">Early-Middle (5-9)</option>
                                <option value="10,11,12,13,14">Mid (10-14)</option>
                                <option value="15,16,17,18,19">Late-Middle (15-19)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Which transformer layers to skip. Z-Image has 30 layers (0-29).</p>
                        </div>

                        <!-- Custom Layers Input -->
                        <div id="slgCustomLayersContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custom Layers</label>
                            <input type="text" id="slgCustomLayers" placeholder="e.g., 7,8,9,10,11,12" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Comma-separated layer indices (0-29)</p>
                        </div>

                        <!-- SLG Timing -->
                        <div id="slgTimingContainer" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Start: <span id="slgStartValue" class="text-blue-400">5%</span>
                                    </label>
                                    <input type="range" id="slgStart" min="0" max="0.5" step="0.01" value="0.05" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Stop: <span id="slgStopValue" class="text-blue-400">50%</span>
                                    </label>
                                    <input type="range" id="slgStop" min="0.1" max="0.8" step="0.01" value="0.5" class="w-full">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">When to apply SLG during denoising. Earlier steps affect structure more.</p>
                        </div>
                    </div>
                </details>

                <!-- FMTT (Flow Map Trajectory Tilting) Options (collapsible) -->
                <details class="group" id="fmttSection">
                    <summary class="flex items-center gap-2 text-sm font-medium text-gray-300 cursor-pointer py-2 select-none">
                        <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        FMTT (Reward Guidance)
                        <span id="fmttStatusBadge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">Off</span>
                    </summary>
                    <div class="pt-2 pb-1 space-y-4 pl-5 border-l-2 border-gray-700/50 ml-1.5">
                        <p class="text-xs text-gray-500">Uses SigLIP to guide generation toward text-aligned images. Loads ~4GB VRAM.</p>

                        <!-- Enable FMTT -->
                        <div>
                            <label for="fmttEnabled" class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="fmttEnabled" class="w-5 h-5 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-300">Enable FMTT</span>
                            </label>
                        </div>

                        <!-- FMTT Scale -->
                        <div id="fmttScaleContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Scale: <span id="fmttScaleValue" class="text-blue-400">1.0</span>
                            </label>
                            <input type="range" id="fmttScale" min="0.1" max="3.0" step="0.1" value="1.0" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.1 (Subtle)</span>
                                <span>3.0 (Strong)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Guidance strength. 0.5-2.0 typical. Higher may cause artifacts.</p>
                        </div>

                        <!-- FMTT Normalize Mode -->
                        <div id="fmttNormalizeContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Normalize: <span id="fmttNormalizeValue" class="text-blue-400">unit</span>
                            </label>
                            <select id="fmttNormalize" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="unit">Unit Norm (Recommended)</option>
                                <option value="clip">Clip</option>
                                <option value="none">None</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How to normalize gradients. Unit is most stable.</p>
                        </div>

                        <!-- FMTT Timing -->
                        <div id="fmttTimingContainer" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Start: <span id="fmttStartValue" class="text-blue-400">0%</span>
                                    </label>
                                    <input type="range" id="fmttStart" min="0" max="0.5" step="0.01" value="0" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Stop: <span id="fmttStopValue" class="text-blue-400">50%</span>
                                    </label>
                                    <input type="range" id="fmttStop" min="0.1" max="0.8" step="0.01" value="0.5" class="w-full">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">When to apply FMTT. Earlier steps affect structure more.</p>
                        </div>

                        <!-- FMTT Decode Scale -->
                        <div id="fmttDecodeScaleContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Decode Scale: <span id="fmttDecodeScaleValue" class="text-blue-400">0.5</span>
                            </label>
                            <input type="range" id="fmttDecodeScale" min="0.25" max="1.0" step="0.05" value="0.5" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.25 (Less VRAM)</span>
                                <span>1.0 (Full res)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Resolution for intermediate VAE decode. Lower saves VRAM.</p>
                        </div>
                    </div>
                </details>

                <!-- Generate Button -->
                <button
                    type="submit"
                    id="generateBtn"
                    class="w-full py-4 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors text-lg shadow-lg shadow-blue-500/20"
                >
                    Generate
                </button>
            </form>

            <!-- Status/Progress -->
            <div id="status" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <span id="statusText" class="text-gray-300">Generating...</span>
                    </div>
                    <div class="mt-3 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="progressFill" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden mt-4">
                <div class="bg-red-900/30 border border-red-700/50 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-red-300 text-sm" id="errorText"></p>
                    </div>
                </div>
            </div>

            <!-- Result -->
            <div id="result" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl overflow-hidden">
                    <img id="resultImage" class="w-full" alt="Generated image">
                    <div class="p-4">
                        <div class="flex items-center justify-between gap-4 mb-3">
                            <div class="text-sm text-gray-400 truncate flex-1" id="resultInfo"></div>
                            <div class="flex gap-2">
                                <button
                                    id="reuseBtn"
                                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Edit this prompt"
                                >
                                    Edit
                                </button>
                                <a
                                    id="downloadBtn"
                                    download="z-image.png"
                                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Save
                                </a>
                            </div>
                        </div>
                        <!-- Formatted Prompt -->
                        <details class="group">
                            <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-300 flex items-center gap-1 select-none">
                                <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                Show formatted prompt
                            </summary>
                            <div class="mt-2 bg-gray-900 rounded-lg p-3">
                                <pre class="text-xs text-gray-300 overflow-x-auto whitespace-pre-wrap font-mono" id="resultFormattedPrompt">-</pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
            </div> <!-- End zImageControls -->
        </div>

        <!-- History Panel -->
        <div id="historyPanel" class="history-panel md:w-80 lg:w-96 bg-gray-800 border-l border-gray-700 md:block hidden collapsed md:!block">
            <!-- Mobile handle -->
            <div class="md:hidden h-12 flex items-center justify-center cursor-pointer" id="historyHandle">
                <div class="w-12 h-1 bg-gray-600 rounded-full"></div>
            </div>

            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="font-semibold text-white">History</h2>
                <button
                    id="clearHistoryBtn"
                    class="text-xs text-gray-400 hover:text-red-400 transition-colors"
                >
                    Clear all
                </button>
            </div>

            <div id="historyList" class="overflow-y-auto p-2" style="max-height: calc(100vh - 120px);">
                <div class="text-center text-gray-500 text-sm py-8">
                    No generations yet
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // DOM Elements
        const form = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const error = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        const result = document.getElementById('result');
        const resultImage = document.getElementById('resultImage');
        const resultInfo = document.getElementById('resultInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const reuseBtn = document.getElementById('reuseBtn');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const historyToggle = document.getElementById('historyToggle');
        const historyHandle = document.getElementById('historyHandle');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const resolutionSelect = document.getElementById('resolution');
        const stepsSlider = document.getElementById('steps');
        const stepsValue = document.getElementById('stepsValue');
        const guidanceScaleSlider = document.getElementById('guidanceScale');
        const guidanceScaleValue = document.getElementById('guidanceScaleValue');
        const shiftSlider = document.getElementById('shift');
        const shiftValue = document.getElementById('shiftValue');
        const longPromptModeSelect = document.getElementById('longPromptMode');
        const hiddenLayerSlider = document.getElementById('hiddenLayer');
        const hiddenLayerValue = document.getElementById('hiddenLayerValue');
        const hiddenLayerLabel = document.getElementById('hiddenLayerLabel');
        const layerPositionIndicator = document.getElementById('layerPositionIndicator');
        const layerPresetButtons = document.querySelectorAll('.layer-preset');

        // Current generation params (for reuse)
        let currentParams = null;

        // Update slider value displays
        stepsSlider.addEventListener('input', () => {
            stepsValue.textContent = stepsSlider.value;
        });

        guidanceScaleSlider.addEventListener('input', () => {
            guidanceScaleValue.textContent = parseFloat(guidanceScaleSlider.value).toFixed(1);
        });

        shiftSlider.addEventListener('input', () => {
            shiftValue.textContent = parseFloat(shiftSlider.value).toFixed(1);
        });

        // Hidden layer helper functions
        function updateHiddenLayerUI(layer) {
            const l = parseInt(layer);
            // Convert negative index to actual layer number (1-36)
            // -1 = layer 36, -2 = layer 35, ..., -35 = layer 2, -36 = layer 1
            const actualLayer = 37 + l;  // -1 -> 36, -35 -> 2

            hiddenLayerValue.textContent = l;
            hiddenLayerLabel.textContent = `(Layer ${actualLayer} of 36)`;

            // Update position indicator (layer -35 = 0%, layer -1 = 100%)
            const percent = ((l + 35) / 34) * 100;
            layerPositionIndicator.style.left = `${percent}%`;

            // Update preset button styling
            layerPresetButtons.forEach(btn => {
                const btnLayer = parseInt(btn.dataset.layer);
                if (btnLayer === l) {
                    btn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                }
            });
        }

        hiddenLayerSlider.addEventListener('input', () => {
            updateHiddenLayerUI(hiddenLayerSlider.value);
        });

        // Layer preset buttons
        layerPresetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const layer = btn.dataset.layer;
                hiddenLayerSlider.value = layer;
                updateHiddenLayerUI(layer);
            });
        });

        // Initialize hidden layer UI
        updateHiddenLayerUI(hiddenLayerSlider.value);

        // =====================================================================
        // DyPE (High-Resolution) Logic
        // =====================================================================
        const dypeEnabled = document.getElementById('dypeEnabled');
        const dypeMethod = document.getElementById('dypeMethod');
        const dypeMultipass = document.getElementById('dypeMultipass');
        const dypeScale = document.getElementById('dypeScale');
        const dypeScaleValue = document.getElementById('dypeScaleValue');
        const dypeExponent = document.getElementById('dypeExponent');
        const dypeExponentValue = document.getElementById('dypeExponentValue');
        const dypeBaseShift = document.getElementById('dypeBaseShift');
        const dypeBaseShiftValue = document.getElementById('dypeBaseShiftValue');
        const dypeMaxShift = document.getElementById('dypeMaxShift');
        const dypeMaxShiftValue = document.getElementById('dypeMaxShiftValue');
        const dypeStrength = document.getElementById('dypeStrength');
        const dypeStrengthValue = document.getElementById('dypeStrengthValue');
        const dypeStrengthContainer = document.getElementById('dypeStrengthContainer');
        const dypeStatusBadge = document.getElementById('dypeStatusBadge');

        // Update status badge
        function updateDypeStatus() {
            if (dypeEnabled.checked) {
                dypeStatusBadge.textContent = 'On';
                dypeStatusBadge.classList.remove('bg-gray-700', 'text-gray-400');
                dypeStatusBadge.classList.add('bg-green-700', 'text-green-300');
            } else {
                dypeStatusBadge.textContent = 'Off';
                dypeStatusBadge.classList.remove('bg-green-700', 'text-green-300');
                dypeStatusBadge.classList.add('bg-gray-700', 'text-gray-400');
            }
        }

        // Update multipass visibility
        function updateMultipassVisibility() {
            const mode = dypeMultipass.value;
            if (mode === 'single') {
                dypeStrengthContainer.classList.add('hidden');
            } else {
                dypeStrengthContainer.classList.remove('hidden');
            }
        }

        // DyPE slider updates
        dypeScale.addEventListener('input', () => {
            dypeScaleValue.textContent = parseFloat(dypeScale.value).toFixed(1);
        });

        dypeExponent.addEventListener('input', () => {
            dypeExponentValue.textContent = parseFloat(dypeExponent.value).toFixed(1);
        });

        dypeBaseShift.addEventListener('input', () => {
            dypeBaseShiftValue.textContent = parseFloat(dypeBaseShift.value).toFixed(2);
        });

        dypeMaxShift.addEventListener('input', () => {
            dypeMaxShiftValue.textContent = parseFloat(dypeMaxShift.value).toFixed(2);
        });

        dypeStrength.addEventListener('input', () => {
            dypeStrengthValue.textContent = parseFloat(dypeStrength.value).toFixed(2);
        });

        dypeEnabled.addEventListener('change', updateDypeStatus);
        dypeMultipass.addEventListener('change', updateMultipassVisibility);

        // Initialize DyPE UI
        updateDypeStatus();
        updateMultipassVisibility();

        // Get DyPE config for API calls
        function getDypeConfig() {
            if (!dypeEnabled.checked) {
                return null;
            }
            return {
                enabled: true,
                method: dypeMethod.value,
                multipass: dypeMultipass.value,
                dype_scale: parseFloat(dypeScale.value),
                dype_exponent: parseFloat(dypeExponent.value),
                base_shift: parseFloat(dypeBaseShift.value),
                max_shift: parseFloat(dypeMaxShift.value),
                pass2_strength: parseFloat(dypeStrength.value)
            };
        }
        // =====================================================================
        // End DyPE Logic
        // =====================================================================

        // =====================================================================
        // SLG (Skip Layer Guidance) Logic
        // =====================================================================
        const slgEnabled = document.getElementById('slgEnabled');
        const slgScale = document.getElementById('slgScale');
        const slgScaleValue = document.getElementById('slgScaleValue');
        const slgScaleContainer = document.getElementById('slgScaleContainer');
        const slgLayers = document.getElementById('slgLayers');
        const slgLayersValue = document.getElementById('slgLayersValue');
        const slgLayersContainer = document.getElementById('slgLayersContainer');
        const slgCustomLayers = document.getElementById('slgCustomLayers');
        const slgCustomLayersContainer = document.getElementById('slgCustomLayersContainer');
        const slgStart = document.getElementById('slgStart');
        const slgStartValue = document.getElementById('slgStartValue');
        const slgStop = document.getElementById('slgStop');
        const slgStopValue = document.getElementById('slgStopValue');
        const slgTimingContainer = document.getElementById('slgTimingContainer');
        const slgStatusBadge = document.getElementById('slgStatusBadge');

        // Update SLG status badge and visibility
        function updateSlgStatus() {
            if (slgEnabled.checked) {
                slgStatusBadge.textContent = 'On';
                slgStatusBadge.classList.remove('bg-gray-700', 'text-gray-400');
                slgStatusBadge.classList.add('bg-green-700', 'text-green-300');
                slgScaleContainer.classList.remove('hidden');
                slgLayersContainer.classList.remove('hidden');
                slgTimingContainer.classList.remove('hidden');
            } else {
                slgStatusBadge.textContent = 'Off';
                slgStatusBadge.classList.remove('bg-green-700', 'text-green-300');
                slgStatusBadge.classList.add('bg-gray-700', 'text-gray-400');
                slgScaleContainer.classList.add('hidden');
                slgLayersContainer.classList.add('hidden');
                slgTimingContainer.classList.add('hidden');
                slgCustomLayersContainer.classList.add('hidden');
            }
        }

        // Update layers dropdown display
        function updateSlgLayersDisplay() {
            const value = slgLayers.value;
            if (value === 'custom') {
                slgCustomLayersContainer.classList.remove('hidden');
                slgLayersValue.textContent = 'Custom';
            } else {
                slgCustomLayersContainer.classList.add('hidden');
                const layers = value.split(',').map(x => parseInt(x.trim()));
                if (layers.length > 2) {
                    slgLayersValue.textContent = `${layers[0]}-${layers[layers.length-1]}`;
                } else {
                    slgLayersValue.textContent = value;
                }
            }
        }

        // Update slider displays
        slgScale.addEventListener('input', () => {
            slgScaleValue.textContent = parseFloat(slgScale.value).toFixed(1);
        });

        slgStart.addEventListener('input', () => {
            slgStartValue.textContent = `${Math.round(parseFloat(slgStart.value) * 100)}%`;
        });

        slgStop.addEventListener('input', () => {
            slgStopValue.textContent = `${Math.round(parseFloat(slgStop.value) * 100)}%`;
        });

        slgEnabled.addEventListener('change', updateSlgStatus);
        slgLayers.addEventListener('change', updateSlgLayersDisplay);

        // Initialize SLG UI
        updateSlgStatus();
        updateSlgLayersDisplay();

        // Get SLG config for API calls
        function getSlgConfig() {
            if (!slgEnabled.checked) {
                return {
                    slg_scale: 0.0,
                    slg_layers: null,
                    slg_start: null,
                    slg_stop: null
                };
            }

            // Parse layers
            let layers;
            if (slgLayers.value === 'custom') {
                layers = slgCustomLayers.value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            } else {
                layers = slgLayers.value.split(',').map(x => parseInt(x.trim()));
            }

            return {
                slg_scale: parseFloat(slgScale.value),
                slg_layers: layers,
                slg_start: parseFloat(slgStart.value),
                slg_stop: parseFloat(slgStop.value)
            };
        }

        // Load SLG config from server
        async function loadSlgConfig() {
            try {
                const resp = await fetch('/api/generation-config');
                if (resp.ok) {
                    const config = await resp.json();
                    if (config.slg_scale && config.slg_scale > 0 && config.slg_layers) {
                        slgEnabled.checked = true;
                        slgScale.value = config.slg_scale;
                        slgScaleValue.textContent = config.slg_scale.toFixed(1);

                        // Match layers to dropdown option or set custom
                        const layerStr = config.slg_layers.join(',');
                        let matched = false;
                        for (const option of slgLayers.options) {
                            if (option.value === layerStr) {
                                slgLayers.value = layerStr;
                                matched = true;
                                break;
                            }
                        }
                        if (!matched) {
                            slgLayers.value = 'custom';
                            slgCustomLayers.value = layerStr;
                        }

                        if (config.slg_start !== undefined) {
                            slgStart.value = config.slg_start;
                            slgStartValue.textContent = `${Math.round(config.slg_start * 100)}%`;
                        }
                        if (config.slg_stop !== undefined) {
                            slgStop.value = config.slg_stop;
                            slgStopValue.textContent = `${Math.round(config.slg_stop * 100)}%`;
                        }

                        updateSlgStatus();
                        updateSlgLayersDisplay();
                    }
                }
            } catch (e) {
                console.warn('Failed to load SLG config:', e);
            }
        }

        // Load SLG config on page load
        loadSlgConfig();
        // =====================================================================
        // End SLG Logic
        // =====================================================================

        // =====================================================================
        // FMTT (Flow Map Trajectory Tilting) Logic
        // =====================================================================

        // FMTT Elements
        const fmttEnabled = document.getElementById('fmttEnabled');
        const fmttScale = document.getElementById('fmttScale');
        const fmttScaleValue = document.getElementById('fmttScaleValue');
        const fmttNormalize = document.getElementById('fmttNormalize');
        const fmttNormalizeValue = document.getElementById('fmttNormalizeValue');
        const fmttStart = document.getElementById('fmttStart');
        const fmttStartValue = document.getElementById('fmttStartValue');
        const fmttStop = document.getElementById('fmttStop');
        const fmttStopValue = document.getElementById('fmttStopValue');
        const fmttDecodeScale = document.getElementById('fmttDecodeScale');
        const fmttDecodeScaleValue = document.getElementById('fmttDecodeScaleValue');
        const fmttScaleContainer = document.getElementById('fmttScaleContainer');
        const fmttNormalizeContainer = document.getElementById('fmttNormalizeContainer');
        const fmttTimingContainer = document.getElementById('fmttTimingContainer');
        const fmttDecodeScaleContainer = document.getElementById('fmttDecodeScaleContainer');
        const fmttStatusBadge = document.getElementById('fmttStatusBadge');

        // Update FMTT status badge and visibility
        function updateFmttStatus() {
            if (fmttEnabled.checked) {
                fmttStatusBadge.textContent = 'On';
                fmttStatusBadge.classList.remove('bg-gray-700', 'text-gray-400');
                fmttStatusBadge.classList.add('bg-green-700', 'text-green-300');
                fmttScaleContainer.classList.remove('hidden');
                fmttNormalizeContainer.classList.remove('hidden');
                fmttTimingContainer.classList.remove('hidden');
                fmttDecodeScaleContainer.classList.remove('hidden');
            } else {
                fmttStatusBadge.textContent = 'Off';
                fmttStatusBadge.classList.remove('bg-green-700', 'text-green-300');
                fmttStatusBadge.classList.add('bg-gray-700', 'text-gray-400');
                fmttScaleContainer.classList.add('hidden');
                fmttNormalizeContainer.classList.add('hidden');
                fmttTimingContainer.classList.add('hidden');
                fmttDecodeScaleContainer.classList.add('hidden');
            }
        }

        // Update display values
        fmttScale.addEventListener('input', () => {
            fmttScaleValue.textContent = parseFloat(fmttScale.value).toFixed(1);
        });
        fmttNormalize.addEventListener('change', () => {
            fmttNormalizeValue.textContent = fmttNormalize.value;
        });
        fmttStart.addEventListener('input', () => {
            fmttStartValue.textContent = `${Math.round(parseFloat(fmttStart.value) * 100)}%`;
        });
        fmttStop.addEventListener('input', () => {
            fmttStopValue.textContent = `${Math.round(parseFloat(fmttStop.value) * 100)}%`;
        });
        fmttDecodeScale.addEventListener('input', () => {
            fmttDecodeScaleValue.textContent = parseFloat(fmttDecodeScale.value).toFixed(2);
        });

        fmttEnabled.addEventListener('change', updateFmttStatus);

        // Initialize FMTT UI
        updateFmttStatus();

        // Get FMTT config for API calls
        function getFmttConfig() {
            if (!fmttEnabled.checked) {
                return {
                    fmtt_scale: 0.0,
                    fmtt_start: null,
                    fmtt_stop: null,
                    fmtt_normalize: null,
                    fmtt_decode_scale: null
                };
            }

            return {
                fmtt_scale: parseFloat(fmttScale.value),
                fmtt_start: parseFloat(fmttStart.value),
                fmtt_stop: parseFloat(fmttStop.value),
                fmtt_normalize: fmttNormalize.value,
                fmtt_decode_scale: parseFloat(fmttDecodeScale.value)
            };
        }

        // Load FMTT config from server
        async function loadFmttConfig() {
            try {
                const resp = await fetch('/api/generation-config');
                if (resp.ok) {
                    const config = await resp.json();
                    if (config.fmtt_scale && config.fmtt_scale > 0) {
                        fmttEnabled.checked = true;
                        fmttScale.value = config.fmtt_scale;
                        fmttScaleValue.textContent = config.fmtt_scale.toFixed(1);

                        if (config.fmtt_normalize) {
                            fmttNormalize.value = config.fmtt_normalize;
                            fmttNormalizeValue.textContent = config.fmtt_normalize;
                        }
                        if (config.fmtt_start !== undefined) {
                            fmttStart.value = config.fmtt_start;
                            fmttStartValue.textContent = `${Math.round(config.fmtt_start * 100)}%`;
                        }
                        if (config.fmtt_stop !== undefined) {
                            fmttStop.value = config.fmtt_stop;
                            fmttStopValue.textContent = `${Math.round(config.fmtt_stop * 100)}%`;
                        }
                        if (config.fmtt_decode_scale !== undefined) {
                            fmttDecodeScale.value = config.fmtt_decode_scale;
                            fmttDecodeScaleValue.textContent = config.fmtt_decode_scale.toFixed(2);
                        }

                        updateFmttStatus();
                    }
                }
            } catch (e) {
                console.warn('Failed to load FMTT config:', e);
            }
        }

        // Load FMTT config on page load
        loadFmttConfig();
        // =====================================================================
        // End FMTT Logic
        // =====================================================================

        // Toggle thinking content visibility based on checkbox
        const enableThinkingCheckbox = document.getElementById('enableThinking');
        const thinkingContentWrapper = document.getElementById('thinkingContentWrapper');

        function updateThinkingContentVisibility() {
            if (enableThinkingCheckbox.checked) {
                thinkingContentWrapper.classList.remove('hidden');
            } else {
                thinkingContentWrapper.classList.add('hidden');
            }
        }

        enableThinkingCheckbox.addEventListener('change', updateThinkingContentVisibility);

        // History panel toggle (mobile)
        function toggleHistoryPanel() {
            historyPanel.classList.toggle('collapsed');
            historyPanel.classList.toggle('hidden');
            document.body.classList.toggle('panel-open', !historyPanel.classList.contains('collapsed'));
        }
        historyToggle?.addEventListener('click', toggleHistoryPanel);
        historyHandle?.addEventListener('click', toggleHistoryPanel);

        // Store template data for auto-population
        let templateData = {};

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates`);
                const data = await response.json();
                const select = document.getElementById('template');
                select.innerHTML = '<option value="">None (raw prompt)</option>';

                // Group templates by category
                const categories = {};
                data.templates.forEach(t => {
                    templateData[t.name] = t;
                    const cat = t.category || 'general';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(t);
                });

                // Add options grouped by category
                Object.keys(categories).sort().forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.charAt(0).toUpperCase() + cat.slice(1);
                    categories[cat].forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.name;
                        opt.textContent = t.name.replace(/^z_image_/, '').replace(/_/g, ' ');
                        if (t.thinking_content) opt.textContent += ' *';
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                });

                // Add template change listener
                select.addEventListener('change', onTemplateChange);
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }

        // Handle template selection - auto-populate fields
        function onTemplateChange(e) {
            const name = e.target.value;
            const systemPromptEl = document.getElementById('systemPrompt');
            const thinkingContentEl = document.getElementById('thinkingContent');
            const assistantContentEl = document.getElementById('assistantContent');
            const enableThinkingEl = document.getElementById('enableThinking');

            if (!name || !templateData[name]) {
                // Clear fields if no template selected
                systemPromptEl.value = '';
                thinkingContentEl.value = '';
                assistantContentEl.value = '';
                enableThinkingEl.checked = false;
                updateThinkingContentVisibility();
                return;
            }

            const t = templateData[name];

            // Always populate system prompt (the main template content)
            systemPromptEl.value = t.system_prompt || '';

            // Populate thinking content if template has it
            if (t.thinking_content) {
                thinkingContentEl.value = t.thinking_content;
                enableThinkingEl.checked = true;  // Auto-check if template has thinking content
            }
            // Don't clear thinking content or uncheck if template doesn't have it
            // This preserves user's manual input

            // Populate assistant content if template has it
            if (t.assistant_content) {
                assistantContentEl.value = t.assistant_content;
            }

            // Only explicitly check/uncheck if template specifies add_think_block: true
            if (t.add_think_block === true) {
                enableThinkingEl.checked = true;
            }

            // Update thinking content visibility based on checkbox state
            updateThinkingContentVisibility();
        }

        // Rewriter mode toggle
        let rewriterMode = 'template'; // 'template' or 'custom'

        function setupRewriterModeToggle() {
            const templateBtn = document.getElementById('rewriterModeTemplate');
            const customBtn = document.getElementById('rewriterModeCustom');
            const templateMode = document.getElementById('rewriterTemplateMode');
            const customMode = document.getElementById('rewriterCustomMode');

            templateBtn.addEventListener('click', () => {
                rewriterMode = 'template';
                templateBtn.classList.remove('bg-gray-700', 'text-gray-300');
                templateBtn.classList.add('bg-blue-600', 'text-white');
                customBtn.classList.remove('bg-blue-600', 'text-white');
                customBtn.classList.add('bg-gray-700', 'text-gray-300');
                templateMode.classList.remove('hidden');
                customMode.classList.add('hidden');
            });

            customBtn.addEventListener('click', () => {
                rewriterMode = 'custom';
                customBtn.classList.remove('bg-gray-700', 'text-gray-300');
                customBtn.classList.add('bg-blue-600', 'text-white');
                templateBtn.classList.remove('bg-blue-600', 'text-white');
                templateBtn.classList.add('bg-gray-700', 'text-gray-300');
                customMode.classList.remove('hidden');
                templateMode.classList.add('hidden');
            });
        }

        // Load generation config from server (long_prompt_mode, hidden_layer, etc.)
        async function loadGenerationConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/generation-config`);
                const config = await response.json();
                // Update form fields with server config defaults
                document.getElementById('longPromptMode').value = config.long_prompt_mode ?? 'interpolate';
                document.getElementById('hiddenLayer').value = config.hidden_layer ?? -2;
                updateHiddenLayerUI(config.hidden_layer ?? -2);
                document.getElementById('shift').value = config.shift ?? 3.0;
                document.getElementById('shiftValue').textContent = (config.shift ?? 3.0).toFixed(1);
                document.getElementById('steps').value = config.steps ?? 9;
                document.getElementById('stepsValue').textContent = config.steps ?? 9;
                document.getElementById('guidanceScale').value = config.guidance_scale ?? 0.0;
                document.getElementById('guidanceScaleValue').textContent = (config.guidance_scale ?? 0.0).toFixed(1);
                console.log(`[Generation Config] Loaded: long_prompt_mode=${config.long_prompt_mode}, hidden_layer=${config.hidden_layer}`);
            } catch (err) {
                console.error('Failed to load generation config:', err);
            }
        }

        // Load rewriter config from server
        async function loadRewriterConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriter-config`);
                const config = await response.json();
                // Update form fields with server config defaults
                // Use ?? (nullish coalescing) instead of || so that 0 values are preserved
                document.getElementById('rewriterMaxTokens').value = config.max_tokens ?? 512;
                document.getElementById('rewriterTemperature').value = config.temperature ?? 0.6;
                document.getElementById('rewriterTopP').value = config.top_p ?? 0.95;
                document.getElementById('rewriterTopK').value = config.top_k ?? 20;
                document.getElementById('rewriterMinP').value = config.min_p ?? 0.0;
                document.getElementById('rewriterPresencePenalty').value = config.presence_penalty ?? 0.0;
            } catch (err) {
                console.error('Failed to load rewriter config:', err);
            }
        }

        // Load rewriters
        async function loadRewriters() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriters`);
                const data = await response.json();
                const select = document.getElementById('rewriterTemplate');
                select.innerHTML = '<option value="">Select a rewriter...</option>';

                if (data.rewriters && data.rewriters.length > 0) {
                    data.rewriters.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.name;
                        opt.textContent = r.description || r.name;
                        select.appendChild(opt);
                    });
                    // Set default to detailed_captioner if available, otherwise rewriter_official
                    const defaultRewriter = data.rewriters.find(r => r.name === 'rewriter_detailed_captioner')
                        || data.rewriters.find(r => r.name === 'rewriter_official');
                    if (defaultRewriter) {
                        select.value = defaultRewriter.name;
                    }
                }
                // Always setup mode toggle (custom mode always available)
                setupRewriterModeToggle();
                // Load config defaults after rewriters
                loadRewriterConfig();
            } catch (err) {
                console.error('Failed to load rewriters:', err);
                // Still setup mode toggle for custom mode
                setupRewriterModeToggle();
                // Still try to load config
                loadRewriterConfig();
            }
        }

        // Rewrite prompt
        const rewriteBtn = document.getElementById('rewriteBtn');
        const rewriteStatus = document.getElementById('rewriteStatus');
        const rewrittenResult = document.getElementById('rewrittenResult');
        const rewrittenText = document.getElementById('rewrittenText');
        const rewriteInfo = document.getElementById('rewriteInfo');
        const useRewrittenBtn = document.getElementById('useRewrittenBtn');
        const copyRewrittenBtn = document.getElementById('copyRewrittenBtn');

        let lastRewrittenPrompt = '';
        let lastThinkingContent = null;

        // Rewriter model and image state
        let rewriterModels = [];
        let rewriterImageBase64 = null;

        // Load available rewriter models
        async function loadRewriterModels() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriter-models`);
                const data = await response.json();
                rewriterModels = data.models;

                const select = document.getElementById('rewriterModel');
                select.innerHTML = data.models.map(m =>
                    `<option value="${m.id}">${m.name}${m.loaded ? ' (loaded)' : ''}</option>`
                ).join('');

                // Set up model change handler
                select.addEventListener('change', onRewriterModelChange);

                // Initial state check
                onRewriterModelChange();
            } catch (err) {
                console.error('Failed to load rewriter models:', err);
            }
        }

        // Handle rewriter model change - show/hide image upload
        function onRewriterModelChange() {
            const modelId = document.getElementById('rewriterModel').value;
            const model = rewriterModels.find(m => m.id === modelId);
            const imageUpload = document.getElementById('rewriterImageUpload');

            if (model?.supports_image) {
                imageUpload.classList.remove('hidden');
            } else {
                imageUpload.classList.add('hidden');
                rewriterImageBase64 = null;
                clearRewriterImagePreview();
            }
        }

        // Clear rewriter image preview
        function clearRewriterImagePreview() {
            const dropzoneContent = document.getElementById('rewriterDropzoneContent');
            const imagePreview = document.getElementById('rewriterImagePreview');
            dropzoneContent.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            rewriterImageBase64 = null;
        }

        // Set up rewriter image upload handlers
        function setupRewriterImageUpload() {
            const imageInput = document.getElementById('rewriterImageInput');
            const dropzone = document.getElementById('rewriterDropzone');
            const clearBtn = document.getElementById('rewriterClearImage');

            // File input change
            imageInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleRewriterImageFile(e.target.files[0]);
                }
            });

            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-purple-500', 'bg-gray-800/50');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleRewriterImageFile(e.dataTransfer.files[0]);
                }
            });

            // Clear button
            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                clearRewriterImagePreview();
                imageInput.value = '';
            });
        }

        // Handle rewriter image file upload
        function handleRewriterImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                rewriterImageBase64 = e.target.result;

                // Show preview
                const dropzoneContent = document.getElementById('rewriterDropzoneContent');
                const imagePreview = document.getElementById('rewriterImagePreview');
                const previewImg = document.getElementById('rewriterPreviewImg');

                dropzoneContent.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                previewImg.src = rewriterImageBase64;
            };
            reader.readAsDataURL(file);
        }

        // Initialize rewriter image upload
        setupRewriterImageUpload();

        rewriteBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('prompt').value.trim();
            const rewriter = document.getElementById('rewriterTemplate').value;
            const customPrompt = document.getElementById('customRewriterPrompt').value.trim();
            // Use helper to preserve 0 values while handling NaN from empty inputs
            const parseNum = (val, fallback) => { const n = parseFloat(val); return Number.isNaN(n) ? fallback : n; };
            const maxTokens = parseInt(document.getElementById('rewriterMaxTokens').value) || 512;
            const temperature = parseNum(document.getElementById('rewriterTemperature').value, 0.6);
            const topP = parseNum(document.getElementById('rewriterTopP').value, 0.95);
            const topK = parseInt(document.getElementById('rewriterTopK').value) || 20;
            const minP = parseNum(document.getElementById('rewriterMinP').value, 0.0);
            const presencePenalty = parseNum(document.getElementById('rewriterPresencePenalty').value, 0.0);
            const selectedModel = document.getElementById('rewriterModel').value;
            const isVLModel = selectedModel === 'qwen3-vl' || selectedModel === 'qwen3-vl-api';

            // Validate: need prompt OR image (VL only)
            if (!prompt && !(isVLModel && rewriterImageBase64)) {
                alert(isVLModel ? 'Please enter a prompt or upload an image' : 'Please enter a prompt first');
                return;
            }

            // Validate based on mode
            if (rewriterMode === 'template' && !rewriter) {
                alert('Please select a rewriter style');
                return;
            }
            if (rewriterMode === 'custom' && !customPrompt) {
                alert('Please enter custom rewriting instructions');
                return;
            }

            // Show status
            rewriteBtn.disabled = true;
            rewriteStatus.classList.remove('hidden');
            rewrittenResult.classList.add('hidden');

            try {
                // Build request based on mode
                const requestBody = {
                    prompt: prompt || null,
                    model: selectedModel,
                    max_tokens: maxTokens,
                    temperature,
                    top_p: topP,
                    top_k: topK,
                    min_p: minP,
                    presence_penalty: presencePenalty,
                };

                // Add image if using VL model
                if (isVLModel && rewriterImageBase64) {
                    requestBody.image = rewriterImageBase64;
                }

                if (rewriterMode === 'template') {
                    requestBody.rewriter = rewriter;
                } else {
                    requestBody.custom_system_prompt = customPrompt;
                }

                const response = await fetch(`${API_BASE}/api/rewrite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Rewrite failed');
                }

                const data = await response.json();
                lastRewrittenPrompt = data.rewritten_prompt;
                lastThinkingContent = data.thinking_content || null;
                rewrittenText.textContent = data.rewritten_prompt;
                const modeLabel = rewriterMode === 'custom' ? 'custom prompt' : data.rewriter;
                // Model label: use returned model name, with fallback mapping for known models
                let modelLabel = data.model;
                if (data.model === 'qwen3-vl') modelLabel = 'Qwen3-VL (local)';
                else if (data.model === 'qwen3-4b') modelLabel = 'Qwen3-4B';
                let infoText = `Generated in ${data.gen_time.toFixed(2)}s using ${modelLabel}`;
                if (modeLabel) {
                    infoText += ` + ${modeLabel}`;
                }
                if (lastThinkingContent) {
                    infoText += ` (thinking: ${lastThinkingContent.length} chars)`;
                }
                rewriteInfo.textContent = infoText;
                rewrittenResult.classList.remove('hidden');

                // Show/hide extracted thinking content
                const extractedThinkingResult = document.getElementById('extractedThinkingResult');
                const extractedThinkingText = document.getElementById('extractedThinkingText');
                if (lastThinkingContent) {
                    extractedThinkingText.textContent = lastThinkingContent;
                    extractedThinkingResult.classList.remove('hidden');
                } else {
                    extractedThinkingResult.classList.add('hidden');
                }

            } catch (err) {
                alert('Rewrite failed: ' + err.message);
            } finally {
                rewriteBtn.disabled = false;
                rewriteStatus.classList.add('hidden');
            }
        });

        // Use rewritten prompt
        useRewrittenBtn.addEventListener('click', () => {
            if (lastRewrittenPrompt) {
                document.getElementById('prompt').value = lastRewrittenPrompt;
                // If thinking content was extracted, set it in the thinking field
                if (lastThinkingContent) {
                    document.getElementById('thinkingContent').value = lastThinkingContent;
                }
                // Collapse the rewriter section
                document.getElementById('rewriterSection').removeAttribute('open');
                // Scroll to prompt
                document.getElementById('prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('prompt').focus();
            }
        });

        // Copy rewritten prompt
        copyRewrittenBtn.addEventListener('click', async () => {
            if (lastRewrittenPrompt) {
                try {
                    await navigator.clipboard.writeText(lastRewrittenPrompt);
                    const originalText = copyRewrittenBtn.textContent;
                    copyRewrittenBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyRewrittenBtn.textContent = originalText;
                    }, 1500);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            }
        });

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/history`);
                const data = await response.json();
                renderHistory(data.history);
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        // Render history
        function renderHistory(history) {
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">No generations yet</div>';
                return;
            }

            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item relative rounded-lg overflow-hidden mb-2 cursor-pointer group" data-index="${index}">
                    <img src="data:image/png;base64,${item.image_b64}" class="w-full aspect-square object-cover" alt="Generated">
                    <div class="history-overlay absolute inset-0 bg-black/60 opacity-0 flex flex-col justify-end p-2">
                        <p class="text-white text-xs line-clamp-2 mb-1">${escapeHtml(item.prompt.substring(0, 80))}${item.prompt.length > 80 ? '...' : ''}</p>
                        <div class="flex gap-1">
                            <button class="history-reuse flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                Use
                            </button>
                            <button class="history-delete px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                                X
                            </button>
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 text-xs text-white/70 bg-black/50 px-1 rounded">
                        ${item.width}x${item.height}
                    </div>
                </div>
            `).join('');

            // Add event listeners
            historyList.querySelectorAll('.history-reuse').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    reuseHistoryItem(history[index]);
                });
            });

            historyList.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    await deleteHistoryItem(index);
                });
            });

            historyList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    showHistoryItemFull(history[index]);
                });
            });
        }

        // Reuse history item
        function reuseHistoryItem(item) {
            document.getElementById('prompt').value = item.prompt;
            document.getElementById('systemPrompt').value = item.system_prompt || '';
            document.getElementById('thinkingContent').value = item.thinking_content || '';
            document.getElementById('assistantContent').value = item.assistant_content || '';
            document.getElementById('enableThinking').checked = item.force_think_block || false;
            document.getElementById('stripQuotes').checked = item.strip_quotes || false;
            updateThinkingContentVisibility();
            document.getElementById('seed').value = item.seed || '';
            document.getElementById('template').value = item.template || '';

            // Set steps
            stepsSlider.value = item.steps || 9;
            stepsValue.textContent = stepsSlider.value;

            // Set guidance_scale and shift if they exist
            if (item.guidance_scale !== undefined) {
                guidanceScaleSlider.value = item.guidance_scale;
                guidanceScaleValue.textContent = parseFloat(item.guidance_scale).toFixed(1);
            }
            if (item.shift !== undefined) {
                shiftSlider.value = item.shift;
                shiftValue.textContent = parseFloat(item.shift).toFixed(1);
            }
            if (item.long_prompt_mode) {
                longPromptModeSelect.value = item.long_prompt_mode;
            }
            if (item.hidden_layer !== undefined) {
                hiddenLayerSlider.value = item.hidden_layer;
                updateHiddenLayerUI(item.hidden_layer);
            }

            // Set resolution (select matching preset or keep current)
            const resValue = `${item.width}x${item.height}`;
            const resOption = [...resolutionSelect.options].find(o => o.value === resValue);
            if (resOption) {
                resolutionSelect.value = resValue;
            }
            // If no matching preset, keep current selection (presets only now)

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }

            // Scroll to top and focus prompt
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('prompt').focus();
        }

        // Show full history item in result area
        function showHistoryItemFull(item) {
            resultImage.src = `data:image/png;base64,${item.image_b64}`;
            downloadBtn.href = `data:image/png;base64,${item.image_b64}`;

            let infoText = `${item.width}x${item.height}, ${item.steps} steps, ${item.gen_time.toFixed(1)}s`;
            if (item.guidance_scale !== undefined && item.guidance_scale !== 0) {
                infoText += `, CFG ${item.guidance_scale}`;
            }
            if (item.shift !== undefined && item.shift !== 3.0) {
                infoText += `, shift ${item.shift}`;
            }
            if (item.long_prompt_mode && item.long_prompt_mode !== 'truncate') {
                infoText += `, ${item.long_prompt_mode}`;
            }
            if (item.hidden_layer !== undefined && item.hidden_layer !== -2) {
                infoText += `, layer ${item.hidden_layer}`;
            }

            resultInfo.textContent = infoText;
            document.getElementById('resultFormattedPrompt').textContent = item.formatted_prompt || '-';

            currentParams = item;
            result.classList.remove('hidden');

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }
        }

        // Delete history item
        async function deleteHistoryItem(index) {
            try {
                await fetch(`${API_BASE}/api/history/${index}`, { method: 'DELETE' });
                loadHistory();
            } catch (err) {
                console.error('Failed to delete:', err);
            }
        }

        // Clear all history
        clearHistoryBtn.addEventListener('click', async () => {
            if (confirm('Clear all history?')) {
                try {
                    await fetch(`${API_BASE}/api/history`, { method: 'DELETE' });
                    loadHistory();
                } catch (err) {
                    console.error('Failed to clear:', err);
                }
            }
        });

        // Reuse button
        reuseBtn.addEventListener('click', () => {
            if (currentParams) {
                reuseHistoryItem(currentParams);
            }
        });

        // Get current resolution from dropdown
        function getResolution() {
            const [w, h] = resolutionSelect.value.split('x').map(Number);
            return { width: w, height: h };
        }

        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const { width, height } = getResolution();

            // Reset UI
            status.classList.remove('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
            generateBtn.disabled = true;
            progressFill.style.width = '10%';
            statusText.textContent = 'Starting...';

            // Get DyPE, SLG, and FMTT configs
            const dypeConfig = getDypeConfig();
            const slgConfig = getSlgConfig();
            const fmttConfig = getFmttConfig();

            const params = {
                prompt: document.getElementById('prompt').value,
                system_prompt: document.getElementById('systemPrompt').value || null,
                thinking_content: document.getElementById('thinkingContent').value || null,
                assistant_content: document.getElementById('assistantContent').value || null,
                force_think_block: document.getElementById('enableThinking').checked,
                strip_quotes: document.getElementById('stripQuotes').checked,
                template: document.getElementById('template').value || null,
                width,
                height,
                steps: parseInt(stepsSlider.value),
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
                guidance_scale: parseFloat(guidanceScaleSlider.value),
                shift: parseFloat(shiftSlider.value),
                long_prompt_mode: longPromptModeSelect.value,
                hidden_layer: parseInt(hiddenLayerSlider.value),
                dype: dypeConfig,
                ...slgConfig,
                ...fmttConfig,
            };

            currentParams = params;

            // Check if VL conditioning is active
            const vlParams = typeof getVLParams === 'function' ? getVLParams() : {};
            const useVL = vlParams.vl_image || vlParams.vl_embeddings_id;

            try {
                progressFill.style.width = '20%';
                statusText.textContent = 'Formatting prompt...';

                // Get formatted prompt first (fast, no GPU)
                const formatResponse = await fetch(`${API_BASE}/api/format-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });
                let formattedPrompt = '-';
                if (formatResponse.ok) {
                    const formatData = await formatResponse.json();
                    formattedPrompt = formatData.formatted_prompt || '-';
                }

                progressFill.style.width = '30%';
                statusText.textContent = useVL ? 'Generating with VL conditioning...' : 'Generating...';

                // Use VL endpoint if VL conditioning is active
                const endpoint = useVL ? `${API_BASE}/api/vl/generate` : `${API_BASE}/api/generate`;
                const requestBody = useVL ? { ...params, ...vlParams } : params;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Generation failed');
                }

                progressFill.style.width = '70%';
                statusText.textContent = 'Processing...';

                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                const genTime = response.headers.get('X-Generation-Time');
                const seed = response.headers.get('X-Seed');

                resultImage.src = imageUrl;
                downloadBtn.href = imageUrl;

                let infoText = `${width}x${height}, ${params.steps} steps${genTime ? `, ${parseFloat(genTime).toFixed(1)}s` : ''}${seed && seed !== 'random' ? `, seed ${seed}` : ''}`;
                if (params.guidance_scale !== 0) {
                    infoText += `, CFG ${params.guidance_scale}`;
                }
                if (params.shift !== 3.0) {
                    infoText += `, shift ${params.shift}`;
                }
                if (params.long_prompt_mode && params.long_prompt_mode !== 'truncate') {
                    infoText += `, ${params.long_prompt_mode}`;
                }
                if (params.hidden_layer !== undefined && params.hidden_layer !== -2) {
                    infoText += `, layer ${params.hidden_layer}`;
                }
                // Add VL info if used
                if (useVL && vlParams.vl_alpha) {
                    infoText += `, VL ${vlParams.vl_alpha} (${vlParams.vl_blend_mode})`;
                }

                resultInfo.textContent = infoText;
                document.getElementById('resultFormattedPrompt').textContent = formattedPrompt;

                status.classList.add('hidden');
                result.classList.remove('hidden');
                progressFill.style.width = '100%';

                // Reload history
                loadHistory();

            } catch (err) {
                status.classList.add('hidden');
                error.classList.remove('hidden');
                errorText.textContent = err.message;
            } finally {
                generateBtn.disabled = false;
            }
        });

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Token count display with debouncing
        const tokenCountEl = document.getElementById('tokenCount');
        let tokenCountTimeout = null;

        async function updateTokenCount() {
            const prompt = document.getElementById('prompt').value;
            if (!prompt.trim()) {
                tokenCountEl.textContent = '-- / 1504 tokens';
                tokenCountEl.className = 'text-xs text-gray-400';
                return;
            }

            try {
                const params = {
                    prompt: prompt,
                    system_prompt: document.getElementById('systemPrompt').value || null,
                    thinking_content: document.getElementById('thinkingContent').value || null,
                    assistant_content: document.getElementById('assistantContent').value || null,
                    force_think_block: document.getElementById('enableThinking').checked,
                    template: document.getElementById('template').value || null,
                };

                const response = await fetch(`${API_BASE}/api/format-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });

                if (response.ok) {
                    const data = await response.json();
                    const count = data.token_count;
                    const max = data.max_tokens || 1504;
                    const chars = data.char_count || 0;

                    if (count !== null) {
                        // Exact token count available (local encoder)
                        tokenCountEl.textContent = `${count} / ${max} tokens`;
                        if (count > max) {
                            tokenCountEl.className = 'text-xs text-red-400 font-medium';
                        } else if (count > max * 0.9) {
                            tokenCountEl.className = 'text-xs text-yellow-400';
                        } else {
                            tokenCountEl.className = 'text-xs text-green-400';
                        }
                    } else {
                        // No tokenizer (API backend) - show character estimate
                        // Rough estimate: ~3.5 chars per token for English text
                        const estTokens = Math.ceil(chars / 3.5);
                        tokenCountEl.textContent = `~${estTokens} tokens (est. from ${chars} chars)`;
                        if (estTokens > max) {
                            tokenCountEl.className = 'text-xs text-red-400 font-medium';
                        } else if (estTokens > max * 0.85) {
                            tokenCountEl.className = 'text-xs text-yellow-400';
                        } else {
                            tokenCountEl.className = 'text-xs text-gray-400';
                        }
                    }
                }
            } catch (err) {
                // Silently fail - token count is informational
                console.debug('Token count update failed:', err);
            }
        }

        function debouncedTokenCount() {
            if (tokenCountTimeout) clearTimeout(tokenCountTimeout);
            tokenCountTimeout = setTimeout(updateTokenCount, 500);
        }

        // Update token count on input changes
        document.getElementById('prompt').addEventListener('input', debouncedTokenCount);
        document.getElementById('systemPrompt').addEventListener('input', debouncedTokenCount);
        document.getElementById('thinkingContent').addEventListener('input', debouncedTokenCount);
        document.getElementById('assistantContent').addEventListener('input', debouncedTokenCount);
        document.getElementById('enableThinking').addEventListener('change', debouncedTokenCount);
        document.getElementById('template').addEventListener('change', debouncedTokenCount);

        // =====================================================================
        // Vision Conditioning (Qwen3-VL) Logic
        // =====================================================================

        // VL state
        let vlImageBase64 = null;
        let vlEmbeddingsId = null;
        let vlAvailable = false;

        // VL DOM elements
        const vlSection = document.getElementById('vlSection');
        const vlStatusBadge = document.getElementById('vlStatusBadge');
        const vlNotAvailable = document.getElementById('vlNotAvailable');
        const vlControls = document.getElementById('vlControls');
        const vlImageInput = document.getElementById('vlImageInput');
        const vlDropzone = document.getElementById('vlDropzone');
        const vlDropzoneContent = document.getElementById('vlDropzoneContent');
        const vlImagePreview = document.getElementById('vlImagePreview');
        const vlPreviewImg = document.getElementById('vlPreviewImg');
        const vlImageInfo = document.getElementById('vlImageInfo');
        const vlClearImageBtn = document.getElementById('vlClearImage');
        const vlAlphaSlider = document.getElementById('vlAlpha');
        const vlAlphaValue = document.getElementById('vlAlphaValue');
        const vlBlendMode = document.getElementById('vlBlendMode');
        const vlHiddenLayerSlider = document.getElementById('vlHiddenLayer');
        const vlHiddenLayerValue = document.getElementById('vlHiddenLayerValue');
        const vlImageTokensOnly = document.getElementById('vlImageTokensOnly');
        const vlText = document.getElementById('vlText');
        const vlExtractStatus = document.getElementById('vlExtractStatus');
        const vlExtractedInfo = document.getElementById('vlExtractedInfo');
        const vlExtractedDetails = document.getElementById('vlExtractedDetails');
        const vlClearEmbeddingsBtn = document.getElementById('vlClearEmbeddings');
        const vlPresetButtons = document.querySelectorAll('.vl-preset');

        // Check VL availability
        async function checkVLStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/vl/status`);
                const data = await response.json();

                vlAvailable = data.available;

                if (vlAvailable) {
                    vlStatusBadge.textContent = 'Available';
                    vlStatusBadge.classList.remove('bg-gray-700', 'text-gray-400', 'bg-yellow-700', 'text-yellow-300');
                    vlStatusBadge.classList.add('bg-green-700', 'text-green-300');
                    vlNotAvailable.classList.add('hidden');
                    vlControls.classList.remove('hidden');

                    // Load VL config defaults
                    const configResponse = await fetch(`${API_BASE}/api/vl/config`);
                    const config = await configResponse.json();
                    vlAlphaSlider.value = config.alpha;
                    vlAlphaValue.textContent = config.alpha;
                    vlHiddenLayerSlider.value = config.hidden_layer;
                    vlHiddenLayerValue.textContent = config.hidden_layer;
                    vlBlendMode.value = config.blend_mode || 'linear';

                    // Update preset buttons
                    updateVLPresetButtons(config.alpha);
                } else if (data.configured) {
                    vlStatusBadge.textContent = 'Not Loaded';
                    vlStatusBadge.classList.remove('bg-gray-700', 'text-gray-400', 'bg-green-700', 'text-green-300');
                    vlStatusBadge.classList.add('bg-yellow-700', 'text-yellow-300');
                    vlNotAvailable.classList.remove('hidden');
                    vlControls.classList.add('hidden');
                } else {
                    vlStatusBadge.textContent = 'Not Configured';
                    vlStatusBadge.classList.remove('bg-green-700', 'text-green-300', 'bg-yellow-700', 'text-yellow-300');
                    vlStatusBadge.classList.add('bg-gray-700', 'text-gray-400');
                    vlNotAvailable.classList.remove('hidden');
                    vlControls.classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to check VL status:', err);
                vlStatusBadge.textContent = 'Error';
                vlStatusBadge.classList.remove('bg-green-700', 'text-green-300', 'bg-gray-700', 'text-gray-400');
                vlStatusBadge.classList.add('bg-red-700', 'text-red-300');
            }
        }

        // Update VL preset buttons
        function updateVLPresetButtons(selectedAlpha) {
            vlPresetButtons.forEach(btn => {
                const alpha = parseFloat(btn.dataset.alpha);
                if (Math.abs(alpha - selectedAlpha) < 0.01) {
                    btn.classList.remove('bg-gray-700', 'text-gray-300');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                }
            });
        }

        // VL alpha slider
        vlAlphaSlider?.addEventListener('input', () => {
            vlAlphaValue.textContent = vlAlphaSlider.value;
            updateVLPresetButtons(parseFloat(vlAlphaSlider.value));
        });

        // VL preset buttons
        vlPresetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const alpha = parseFloat(btn.dataset.alpha);
                vlAlphaSlider.value = alpha;
                vlAlphaValue.textContent = alpha;
                updateVLPresetButtons(alpha);
            });
        });

        // VL hidden layer slider
        vlHiddenLayerSlider?.addEventListener('input', () => {
            vlHiddenLayerValue.textContent = vlHiddenLayerSlider.value;
        });

        // Image upload handling
        vlImageInput?.addEventListener('change', handleVLImageUpload);
        vlDropzone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            vlDropzone.classList.add('border-blue-500', 'bg-gray-800/50');
        });
        vlDropzone?.addEventListener('dragleave', () => {
            vlDropzone.classList.remove('border-blue-500', 'bg-gray-800/50');
        });
        vlDropzone?.addEventListener('drop', (e) => {
            e.preventDefault();
            vlDropzone.classList.remove('border-blue-500', 'bg-gray-800/50');
            if (e.dataTransfer.files.length > 0) {
                vlImageInput.files = e.dataTransfer.files;
                handleVLImageUpload({ target: vlImageInput });
            }
        });

        async function handleVLImageUpload(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const base64 = ev.target.result.split(',')[1];
                vlImageBase64 = base64;

                // Show preview
                vlPreviewImg.src = ev.target.result;
                vlDropzoneContent.classList.add('hidden');
                vlImagePreview.classList.remove('hidden');
                vlClearImageBtn.classList.remove('hidden');

                // Get image dimensions
                const img = new Image();
                img.onload = () => {
                    vlImageInfo.textContent = `${img.width}x${img.height} - ${(file.size / 1024).toFixed(1)} KB`;

                    // Warn if image is too large (will produce >1504 tokens)
                    const estimatedTokens = Math.ceil(img.width / 28) * Math.ceil(img.height / 28);
                    if (estimatedTokens > 1504) {
                        vlImageInfo.textContent += ` (Warning: ~${estimatedTokens} tokens, may exceed limit)`;
                        vlImageInfo.classList.add('text-yellow-400');
                    } else {
                        vlImageInfo.classList.remove('text-yellow-400');
                    }
                };
                img.src = ev.target.result;

                // Clear any existing embeddings
                vlEmbeddingsId = null;
                vlExtractedInfo.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Clear image
        vlClearImageBtn?.addEventListener('click', () => {
            vlImageBase64 = null;
            vlEmbeddingsId = null;
            vlImageInput.value = '';
            vlDropzoneContent.classList.remove('hidden');
            vlImagePreview.classList.add('hidden');
            vlClearImageBtn.classList.add('hidden');
            vlExtractedInfo.classList.add('hidden');
        });

        // Clear embeddings
        vlClearEmbeddingsBtn?.addEventListener('click', async () => {
            if (vlEmbeddingsId) {
                try {
                    await fetch(`${API_BASE}/api/vl/cache/${vlEmbeddingsId}`, { method: 'DELETE' });
                } catch (err) {
                    console.error('Failed to clear embeddings:', err);
                }
            }
            vlEmbeddingsId = null;
            vlExtractedInfo.classList.add('hidden');
        });

        // Extract VL embeddings (for pre-extraction workflow)
        async function extractVLEmbeddings() {
            if (!vlImageBase64) return null;

            vlExtractStatus.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/vl/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: vlImageBase64,
                        text: vlText.value || null,
                        hidden_layer: parseInt(vlHiddenLayerSlider.value),
                        image_tokens_only: vlImageTokensOnly.checked,
                        scale_to_text: true,
                    }),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Extraction failed');
                }

                const result = await response.json();
                vlEmbeddingsId = result.embeddings_id;

                vlExtractedDetails.textContent = `${result.num_tokens} tokens, layer ${result.hidden_layer}, ${result.extract_time.toFixed(2)}s`;
                vlExtractedInfo.classList.remove('hidden');

                return vlEmbeddingsId;
            } catch (err) {
                console.error('VL extraction failed:', err);
                throw err;
            } finally {
                vlExtractStatus.classList.add('hidden');
            }
        }

        // Get VL parameters for generation request
        function getVLParams() {
            if (!vlAvailable || (!vlImageBase64 && !vlEmbeddingsId)) {
                return {};
            }

            return {
                vl_image: vlEmbeddingsId ? null : vlImageBase64,
                vl_embeddings_id: vlEmbeddingsId || null,
                vl_alpha: parseFloat(vlAlphaSlider.value),
                vl_hidden_layer: parseInt(vlHiddenLayerSlider.value),
                vl_image_tokens_only: vlImageTokensOnly.checked,
                vl_text: vlText.value || null,
                vl_blend_mode: vlBlendMode.value,
            };
        }

        // =====================================================================
        // End Vision Conditioning Logic
        // =====================================================================

        // =====================================================================
        // Model Type Toggle Logic
        // =====================================================================

        let currentModelType = 'zimage';
        let qwenImageAvailable = false;
        let qiImageBase64 = null;
        let qiLastZipBlob = null;

        // DOM Elements for model toggle
        const modelTypeZImageBtn = document.getElementById('modelTypeZImage');
        const modelTypeQwenImageBtn = document.getElementById('modelTypeQwenImage');
        const qwenImageStatus = document.getElementById('qwenImageStatus');
        const qwenImageControls = document.getElementById('qwenImageControls');
        const zImageControls = document.getElementById('zImageControls');
        const headerTitle = document.getElementById('headerTitle');
        const headerSubtitle = document.getElementById('headerSubtitle');

        // Qwen-Image DOM elements
        const qiDropzone = document.getElementById('qiDropzone');
        const qiImageInput = document.getElementById('qiImageInput');
        const qiDropzoneContent = document.getElementById('qiDropzoneContent');
        const qiImagePreview = document.getElementById('qiImagePreview');
        const qiPreviewImg = document.getElementById('qiPreviewImg');
        const qiImageInfo = document.getElementById('qiImageInfo');
        const qiClearImageBtn = document.getElementById('qiClearImage');
        const qiPrompt = document.getElementById('qiPrompt');
        const qiResolution = document.getElementById('qiResolution');
        const qiLayersSlider = document.getElementById('qiLayers');
        const qiLayersValue = document.getElementById('qiLayersValue');
        const qiCfgSlider = document.getElementById('qiCfgScale');
        const qiCfgValue = document.getElementById('qiCfgValue');
        const qiStepsSlider = document.getElementById('qiSteps');
        const qiStepsValue = document.getElementById('qiStepsValue');
        const qiSeed = document.getElementById('qiSeed');
        const decomposeBtn = document.getElementById('decomposeBtn');
        const qiStatus = document.getElementById('qiStatus');
        const qiStatusText = document.getElementById('qiStatusText');
        const qiProgressFill = document.getElementById('qiProgressFill');
        const qiError = document.getElementById('qiError');
        const qiErrorText = document.getElementById('qiErrorText');
        const qiResult = document.getElementById('qiResult');
        const qiLayerGrid = document.getElementById('qiLayerGrid');
        const qiResultInfo = document.getElementById('qiResultInfo');
        const qiDownloadZip = document.getElementById('qiDownloadZip');

        // Update slider displays
        qiLayersSlider?.addEventListener('input', () => {
            qiLayersValue.textContent = qiLayersSlider.value;
        });

        qiCfgSlider?.addEventListener('input', () => {
            qiCfgValue.textContent = parseFloat(qiCfgSlider.value).toFixed(1);
        });

        qiStepsSlider?.addEventListener('input', () => {
            qiStepsValue.textContent = qiStepsSlider.value;
        });

        // Check Qwen-Image status
        async function checkQwenImageStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/qwen-image/status`);
                const data = await response.json();
                qwenImageAvailable = data.available;

                if (!qwenImageAvailable) {
                    qwenImageStatus.classList.remove('hidden');
                    modelTypeQwenImageBtn.disabled = true;
                    modelTypeQwenImageBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } catch (err) {
                console.error('Failed to check Qwen-Image status:', err);
                qwenImageAvailable = false;
            }
        }

        // Switch model type
        function switchModelType(type) {
            currentModelType = type;

            if (type === 'zimage') {
                // Update button styles
                modelTypeZImageBtn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                modelTypeZImageBtn.classList.add('bg-blue-600', 'text-white');
                modelTypeQwenImageBtn.classList.remove('bg-purple-600', 'text-white');
                modelTypeQwenImageBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');

                // Show/hide controls
                zImageControls.classList.remove('hidden');
                qwenImageControls.classList.add('hidden');

                // Update header
                headerTitle.textContent = 'Z-Image';
                headerSubtitle.textContent = 'Text-to-image with Qwen3-4B';
            } else {
                // Update button styles
                modelTypeQwenImageBtn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                modelTypeQwenImageBtn.classList.add('bg-purple-600', 'text-white');
                modelTypeZImageBtn.classList.remove('bg-blue-600', 'text-white');
                modelTypeZImageBtn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');

                // Show/hide controls
                zImageControls.classList.add('hidden');
                qwenImageControls.classList.remove('hidden');

                // Update header
                headerTitle.textContent = 'Qwen-Image';
                headerSubtitle.textContent = 'Image decomposition into layers';
            }
        }

        // Model type button listeners
        modelTypeZImageBtn?.addEventListener('click', () => switchModelType('zimage'));
        modelTypeQwenImageBtn?.addEventListener('click', () => {
            if (qwenImageAvailable) {
                switchModelType('qwenimage');
            }
        });

        // Qwen-Image image upload handling
        qiImageInput?.addEventListener('change', handleQiImageUpload);
        qiDropzone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            qiDropzone.classList.add('border-purple-500', 'bg-gray-800/50');
        });
        qiDropzone?.addEventListener('dragleave', () => {
            qiDropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
        });
        qiDropzone?.addEventListener('drop', (e) => {
            e.preventDefault();
            qiDropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
            if (e.dataTransfer.files.length > 0) {
                qiImageInput.files = e.dataTransfer.files;
                handleQiImageUpload({ target: qiImageInput });
            }
        });

        async function handleQiImageUpload(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (ev) => {
                qiImageBase64 = ev.target.result;  // Keep full data URL

                // Show preview
                qiPreviewImg.src = ev.target.result;
                qiDropzoneContent.classList.add('hidden');
                qiImagePreview.classList.remove('hidden');
                qiClearImageBtn.classList.remove('hidden');

                // Get image dimensions
                const img = new Image();
                img.onload = () => {
                    qiImageInfo.textContent = `${img.width}x${img.height} - ${(file.size / 1024).toFixed(1)} KB`;
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Clear image
        qiClearImageBtn?.addEventListener('click', () => {
            qiImageBase64 = null;
            qiImageInput.value = '';
            qiDropzoneContent.classList.remove('hidden');
            qiImagePreview.classList.add('hidden');
            qiClearImageBtn.classList.add('hidden');
        });

        // Decompose button handler
        decomposeBtn?.addEventListener('click', async () => {
            // Validate inputs
            if (!qiImageBase64) {
                qiError.classList.remove('hidden');
                qiErrorText.textContent = 'Please upload an input image';
                return;
            }

            const prompt = qiPrompt.value.trim();
            if (!prompt) {
                qiError.classList.remove('hidden');
                qiErrorText.textContent = 'Please enter a scene description';
                return;
            }

            // Reset UI
            qiStatus.classList.remove('hidden');
            qiError.classList.add('hidden');
            qiResult.classList.add('hidden');
            decomposeBtn.disabled = true;
            qiProgressFill.style.width = '10%';
            qiStatusText.textContent = 'Starting decomposition...';

            const params = {
                image: qiImageBase64,
                prompt: prompt,
                layer_num: parseInt(qiLayersSlider.value),
                resolution: parseInt(qiResolution.value),
                steps: parseInt(qiStepsSlider.value),
                cfg_scale: parseFloat(qiCfgSlider.value),
                seed: qiSeed.value ? parseInt(qiSeed.value) : null,
            };

            try {
                qiProgressFill.style.width = '20%';
                qiStatusText.textContent = 'Encoding text...';

                const response = await fetch(`${API_BASE}/api/qwen-image/decompose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });

                qiProgressFill.style.width = '60%';
                qiStatusText.textContent = 'Processing layers...';

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Decomposition failed');
                }

                qiProgressFill.style.width = '80%';
                qiStatusText.textContent = 'Rendering results...';

                const data = await response.json();

                // Clear previous results
                qiLayerGrid.innerHTML = '';

                // Store layers globally for editing
                window.qiLayersData = data.layers;

                // Add each layer to the grid
                data.layers.forEach((layer, index) => {
                    const layerDiv = document.createElement('div');
                    layerDiv.className = 'relative group';
                    layerDiv.id = `qiLayer-${index}`;
                    layerDiv.innerHTML = `
                        <img src="${layer.image}" alt="${layer.name}" class="w-full rounded-lg border border-gray-700 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImNoZWNrIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxyZWN0IHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIgZmlsbD0iIzMzMyIvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjMzMzIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCBmaWxsPSJ1cmwoI2NoZWNrKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==')]" data-layer-index="${index}">
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-xs text-gray-400">${layer.name}</p>
                            <button type="button" class="qiEditLayerBtn text-xs px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded transition-colors opacity-0 group-hover:opacity-100" data-layer-index="${index}">
                                Edit
                            </button>
                        </div>
                    `;
                    qiLayerGrid.appendChild(layerDiv);
                });

                // Store zip data for download
                qiLastZipBlob = data.zip_data;

                // Show result info
                const genTime = data.generation_time ? `${data.generation_time.toFixed(1)}s` : '';
                qiResultInfo.textContent = `${data.layers.length} layers, ${params.resolution}x${params.resolution}${genTime ? `, ${genTime}` : ''}`;

                qiProgressFill.style.width = '100%';
                qiStatus.classList.add('hidden');
                qiResult.classList.remove('hidden');

                // Reload history
                loadHistory();

            } catch (err) {
                qiStatus.classList.add('hidden');
                qiError.classList.remove('hidden');
                qiErrorText.textContent = err.message;
            } finally {
                decomposeBtn.disabled = false;
            }
        });

        // Download ZIP button
        qiDownloadZip?.addEventListener('click', () => {
            if (!qiLastZipBlob) return;

            // Convert base64 to blob
            const byteCharacters = atob(qiLastZipBlob);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/zip' });

            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'qwen-image-layers.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // =====================================================================
        // Layer Edit Modal Handling
        // =====================================================================

        // Edit modal DOM elements
        const qiEditModal = document.getElementById('qiEditModal');
        const qiEditClose = document.getElementById('qiEditClose');
        const qiEditLayerName = document.getElementById('qiEditLayerName');
        const qiEditOriginalImg = document.getElementById('qiEditOriginalImg');
        const qiEditInstruction = document.getElementById('qiEditInstruction');
        const qiEditCfgScale = document.getElementById('qiEditCfgScale');
        const qiEditCfgValue = document.getElementById('qiEditCfgValue');
        const qiEditSteps = document.getElementById('qiEditSteps');
        const qiEditStepsValue = document.getElementById('qiEditStepsValue');
        const qiEditSeed = document.getElementById('qiEditSeed');
        const qiEditBtn = document.getElementById('qiEditBtn');
        const qiEditStatus = document.getElementById('qiEditStatus');
        const qiEditStatusText = document.getElementById('qiEditStatusText');
        const qiEditError = document.getElementById('qiEditError');
        const qiEditErrorText = document.getElementById('qiEditErrorText');
        const qiEditResult = document.getElementById('qiEditResult');
        const qiEditResultImg = document.getElementById('qiEditResultImg');
        const qiEditReplace = document.getElementById('qiEditReplace');
        const qiEditDownload = document.getElementById('qiEditDownload');

        // Current editing state
        let currentEditLayerIndex = null;
        let currentEditResultImage = null;

        // Update CFG value display
        qiEditCfgScale?.addEventListener('input', () => {
            if (qiEditCfgValue) qiEditCfgValue.textContent = qiEditCfgScale.value;
        });

        // Update Steps value display
        qiEditSteps?.addEventListener('input', () => {
            if (qiEditStepsValue) qiEditStepsValue.textContent = qiEditSteps.value;
        });

        // Event delegation for edit buttons (since they're dynamically created)
        qiLayerGrid?.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.qiEditLayerBtn');
            if (!editBtn) return;

            const layerIndex = parseInt(editBtn.dataset.layerIndex);
            openEditModal(layerIndex);
        });

        function openEditModal(layerIndex) {
            if (!window.qiLayersData || !window.qiLayersData[layerIndex]) return;

            const layer = window.qiLayersData[layerIndex];
            currentEditLayerIndex = layerIndex;
            currentEditResultImage = null;

            // Set modal content
            qiEditLayerName.textContent = layer.name;
            qiEditOriginalImg.src = layer.image;
            qiEditInstruction.value = '';

            // Reset modal state
            qiEditStatus.classList.add('hidden');
            qiEditError.classList.add('hidden');
            qiEditResult.classList.add('hidden');
            qiEditBtn.disabled = false;

            // Show modal
            qiEditModal.classList.remove('hidden');
            qiEditInstruction.focus();
        }

        // Close modal
        qiEditClose?.addEventListener('click', () => {
            qiEditModal.classList.add('hidden');
            currentEditLayerIndex = null;
            currentEditResultImage = null;
        });

        // Close on backdrop click
        qiEditModal?.addEventListener('click', (e) => {
            if (e.target === qiEditModal) {
                qiEditModal.classList.add('hidden');
                currentEditLayerIndex = null;
                currentEditResultImage = null;
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !qiEditModal.classList.contains('hidden')) {
                qiEditModal.classList.add('hidden');
                currentEditLayerIndex = null;
                currentEditResultImage = null;
            }
        });

        // Apply edit button
        qiEditBtn?.addEventListener('click', async () => {
            const instruction = qiEditInstruction.value.trim();
            if (!instruction) {
                qiEditError.classList.remove('hidden');
                qiEditErrorText.textContent = 'Please enter an edit instruction';
                return;
            }

            if (currentEditLayerIndex === null || !window.qiLayersData) return;

            const layer = window.qiLayersData[currentEditLayerIndex];

            // Reset UI
            qiEditStatus.classList.remove('hidden');
            qiEditError.classList.add('hidden');
            qiEditResult.classList.add('hidden');
            qiEditBtn.disabled = true;
            qiEditStatusText.textContent = 'Loading edit model...';

            const params = {
                layer_image: layer.image,
                instruction: instruction,
                steps: parseInt(qiEditSteps.value),
                cfg_scale: parseFloat(qiEditCfgScale.value),
                seed: qiEditSeed.value ? parseInt(qiEditSeed.value) : null,
            };

            try {
                qiEditStatusText.textContent = 'Editing layer...';

                const response = await fetch(`${API_BASE}/api/qwen-image/edit-layer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Edit failed');
                }

                // Get the edited image
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                // Store for replace action
                currentEditResultImage = imageUrl;

                // Show result
                qiEditResultImg.src = imageUrl;
                qiEditStatus.classList.add('hidden');
                qiEditResult.classList.remove('hidden');

            } catch (err) {
                qiEditStatus.classList.add('hidden');
                qiEditError.classList.remove('hidden');
                qiEditErrorText.textContent = err.message;
            } finally {
                qiEditBtn.disabled = false;
            }
        });

        // Replace original layer
        qiEditReplace?.addEventListener('click', () => {
            if (currentEditLayerIndex === null || !currentEditResultImage || !window.qiLayersData) return;

            // Update the layer data
            // Convert object URL back to data URL for consistency
            const canvas = document.createElement('canvas');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const dataUrl = canvas.toDataURL('image/png');

                // Update stored layer data
                window.qiLayersData[currentEditLayerIndex].image = dataUrl;

                // Update the grid image
                const layerDiv = document.getElementById(`qiLayer-${currentEditLayerIndex}`);
                if (layerDiv) {
                    const imgEl = layerDiv.querySelector('img');
                    if (imgEl) imgEl.src = dataUrl;
                }

                // Close modal
                qiEditModal.classList.add('hidden');
                currentEditLayerIndex = null;
                currentEditResultImage = null;
            };
            img.src = currentEditResultImage;
        });

        // Download edited layer
        qiEditDownload?.addEventListener('click', () => {
            if (!currentEditResultImage) return;

            const a = document.createElement('a');
            a.href = currentEditResultImage;
            a.download = `edited_layer_${currentEditLayerIndex}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // =====================================================================
        // End Model Type Toggle Logic
        // =====================================================================

        // Initialize
        loadTemplates();
        loadRewriters();
        loadRewriterModels();
        loadGenerationConfig();
        loadHistory();
        checkVLStatus();
        checkQwenImageStatus();
    </script>
</body>
</html>
