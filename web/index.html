<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Z-Image Generator</h1>
            <p class="text-gray-400">Text-to-image generation with Qwen3-4B encoder</p>
        </header>

        <!-- Main Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <form id="generateForm" class="space-y-4">
                <!-- System Prompt (collapsible) -->
                <details class="group">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 mb-2">
                        Advanced: System/Thinking/Assistant
                    </summary>
                    <div class="space-y-3 mt-2 p-3 bg-gray-750 rounded-lg border border-gray-600">
                        <!-- System Prompt -->
                        <div>
                            <label for="systemPrompt" class="block text-sm font-medium text-gray-300 mb-1">System Prompt</label>
                            <textarea
                                id="systemPrompt"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="You are a painter. (optional)"
                            ></textarea>
                        </div>
                        <!-- Thinking Content -->
                        <div>
                            <label for="thinkingContent" class="block text-sm font-medium text-gray-300 mb-1">Thinking Content</label>
                            <textarea
                                id="thinkingContent"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="Orange fur, green eyes. (optional, requires Enable thinking)"
                            ></textarea>
                        </div>
                        <!-- Assistant Content -->
                        <div>
                            <label for="assistantContent" class="block text-sm font-medium text-gray-300 mb-1">Assistant Content</label>
                            <textarea
                                id="assistantContent"
                                rows="1"
                                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="Here is your image: (optional, after thinking)"
                            ></textarea>
                        </div>
                    </div>
                </details>

                <!-- User Prompt -->
                <div>
                    <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">User Prompt</label>
                    <textarea
                        id="prompt"
                        name="prompt"
                        rows="3"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="A beautiful sunset over the ocean with golden light reflecting on gentle waves..."
                    ></textarea>
                </div>

                <!-- Settings Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Width -->
                    <div>
                        <label for="width" class="block text-sm font-medium text-gray-300 mb-1">Width</label>
                        <select id="width" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="512">512</option>
                            <option value="768">768</option>
                            <option value="1024" selected>1024</option>
                            <option value="1280">1280</option>
                        </select>
                    </div>

                    <!-- Height -->
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-300 mb-1">Height</label>
                        <select id="height" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="512">512</option>
                            <option value="768">768</option>
                            <option value="1024" selected>1024</option>
                            <option value="1280">1280</option>
                        </select>
                    </div>

                    <!-- Steps -->
                    <div>
                        <label for="steps" class="block text-sm font-medium text-gray-300 mb-1">Steps</label>
                        <input
                            type="number"
                            id="steps"
                            value="9"
                            min="1"
                            max="50"
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>

                    <!-- Seed -->
                    <div>
                        <label for="seed" class="block text-sm font-medium text-gray-300 mb-1">Seed</label>
                        <input
                            type="number"
                            id="seed"
                            placeholder="Random"
                            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                </div>

                <!-- Template -->
                <div>
                    <label for="template" class="block text-sm font-medium text-gray-300 mb-1">Template (optional)</label>
                    <select id="template" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">None (loading...)</option>
                    </select>
                </div>

                <!-- Toggles Row -->
                <div class="flex items-center space-x-6">
                    <div class="flex items-center">
                        <input
                            type="checkbox"
                            id="enableThinking"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                        >
                        <label for="enableThinking" class="ml-2 text-sm text-gray-300">Enable thinking block (experimental)</label>
                    </div>
                    <div class="flex items-center">
                        <input
                            type="checkbox"
                            id="encoderOnly"
                            class="w-4 h-4 text-yellow-600 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500"
                        >
                        <label for="encoderOnly" class="ml-2 text-sm text-gray-300">Encoder only (fast test)</label>
                    </div>
                </div>

                <!-- Generate Button -->
                <button
                    type="submit"
                    id="generateBtn"
                    class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors"
                >
                    Generate Image
                </button>
            </form>
        </div>

        <!-- Status -->
        <div id="status" class="hidden mb-6">
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <div class="loading w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <span id="statusText" class="text-gray-300">Generating...</span>
                </div>
                <div id="progressBar" class="mt-3 h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div id="progressFill" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div id="error" class="hidden mb-6">
            <div class="bg-red-900/50 border border-red-700 rounded-lg p-4">
                <p class="text-red-300" id="errorText"></p>
            </div>
        </div>

        <!-- Image Result -->
        <div id="result" class="hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <img id="resultImage" class="w-full rounded-lg" alt="Generated image">
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-400">
                        <span id="resultInfo"></span>
                    </div>
                    <a
                        id="downloadBtn"
                        download="generated.png"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors"
                    >
                        Download
                    </a>
                </div>
            </div>
        </div>

        <!-- Encoder Result -->
        <div id="encoderResult" class="hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-medium text-white mb-3">Encoder Output</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-700 rounded p-3">
                        <div class="text-gray-400">Shape</div>
                        <div class="text-white font-mono" id="encShape">-</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3">
                        <div class="text-gray-400">Encode Time</div>
                        <div class="text-white font-mono" id="encTime">-</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3">
                        <div class="text-gray-400">Sequence Length</div>
                        <div class="text-white font-mono" id="encSeqLen">-</div>
                    </div>
                    <div class="bg-gray-700 rounded p-3">
                        <div class="text-gray-400">Hidden Dim</div>
                        <div class="text-white font-mono" id="encHiddenDim">-</div>
                    </div>
                </div>
                <div class="mt-4 bg-gray-700 rounded p-3">
                    <div class="text-gray-400 mb-1">Embedding Stats</div>
                    <div class="text-white font-mono text-sm" id="encStats">-</div>
                </div>
                <div class="mt-4">
                    <button
                        id="saveEmbeddingsBtn"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors"
                    >
                        Save Embeddings
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Info -->
        <details class="mt-6">
            <summary class="text-gray-500 cursor-pointer hover:text-gray-400">Debug Info</summary>
            <pre id="debugInfo" class="mt-2 p-4 bg-gray-800 rounded-lg text-xs text-gray-400 overflow-x-auto"></pre>
        </details>
    </div>

    <script>
        const API_BASE = window.location.origin;

        const form = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const encoderOnlyCheckbox = document.getElementById('encoderOnly');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const error = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        const result = document.getElementById('result');
        const encoderResult = document.getElementById('encoderResult');
        const resultImage = document.getElementById('resultImage');
        const resultInfo = document.getElementById('resultInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const debugInfo = document.getElementById('debugInfo');

        // Update button text based on mode
        encoderOnlyCheckbox.addEventListener('change', () => {
            generateBtn.textContent = encoderOnlyCheckbox.checked ? 'Encode Prompt' : 'Generate Image';
            generateBtn.classList.toggle('bg-yellow-600', encoderOnlyCheckbox.checked);
            generateBtn.classList.toggle('hover:bg-yellow-700', encoderOnlyCheckbox.checked);
            generateBtn.classList.toggle('bg-blue-600', !encoderOnlyCheckbox.checked);
            generateBtn.classList.toggle('hover:bg-blue-700', !encoderOnlyCheckbox.checked);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const encoderOnly = encoderOnlyCheckbox.checked;

            // Reset UI
            status.classList.remove('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
            encoderResult.classList.add('hidden');
            generateBtn.disabled = true;
            progressFill.style.width = '0%';
            statusText.textContent = encoderOnly ? 'Encoding prompt...' : 'Starting generation...';

            const params = {
                prompt: document.getElementById('prompt').value,
                system_prompt: document.getElementById('systemPrompt').value || null,
                thinking_content: document.getElementById('thinkingContent').value || null,
                assistant_content: document.getElementById('assistantContent').value || null,
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                steps: parseInt(document.getElementById('steps').value),
                template: document.getElementById('template').value || null,
                enable_thinking: document.getElementById('enableThinking').checked,
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
            };

            debugInfo.textContent = JSON.stringify({ ...params, encoder_only: encoderOnly }, null, 2);

            try {
                if (encoderOnly) {
                    // Encoder-only mode
                    const response = await fetch(`${API_BASE}/api/encode`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: params.prompt,
                            system_prompt: params.system_prompt,
                            thinking_content: params.thinking_content,
                            assistant_content: params.assistant_content,
                            template: params.template,
                            enable_thinking: params.enable_thinking,
                        }),
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Encoding failed');
                    }

                    const data = await response.json();
                    debugInfo.textContent += '\n\nResponse:\n' + JSON.stringify(data, null, 2);

                    // Display encoder results
                    document.getElementById('encShape').textContent = `[${data.shape.join(', ')}]`;
                    document.getElementById('encTime').textContent = `${data.encode_time.toFixed(3)}s`;
                    document.getElementById('encSeqLen').textContent = data.shape[0];
                    document.getElementById('encHiddenDim').textContent = data.shape[1];
                    document.getElementById('encStats').textContent = `dtype: ${data.dtype}`;

                    status.classList.add('hidden');
                    encoderResult.classList.remove('hidden');
                    progressFill.style.width = '100%';

                } else {
                    // Full generation mode
                    const response = await fetch(`${API_BASE}/api/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params),
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Generation failed');
                    }

                    // Handle streaming response
                    const reader = response.body.getReader();
                    const chunks = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        chunks.push(value);
                        progressFill.style.width = '50%';
                        statusText.textContent = 'Generating...';
                    }

                    // Combine chunks and create blob
                    const blob = new Blob(chunks, { type: 'image/png' });
                    const imageUrl = URL.createObjectURL(blob);

                    // Show result
                    resultImage.src = imageUrl;
                    downloadBtn.href = imageUrl;
                    resultInfo.textContent = `${params.width}x${params.height}, ${params.steps} steps`;

                    status.classList.add('hidden');
                    result.classList.remove('hidden');
                    progressFill.style.width = '100%';
                }

            } catch (err) {
                status.classList.add('hidden');
                error.classList.remove('hidden');
                errorText.textContent = err.message;
                debugInfo.textContent += '\n\nError: ' + err.message;
            } finally {
                generateBtn.disabled = false;
            }
        });

        // Load templates on page load
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates`);
                const data = await response.json();
                const select = document.getElementById('template');
                select.innerHTML = '<option value="">None</option>';
                data.templates.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.textContent = t.name + (t.has_thinking ? ' (thinking)' : '');
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }
        loadTemplates();

        // Save embeddings button
        document.getElementById('saveEmbeddingsBtn').addEventListener('click', async () => {
            const prompt = document.getElementById('prompt').value;
            const template = document.getElementById('template').value || null;
            const enableThinking = document.getElementById('enableThinking').checked;

            try {
                const response = await fetch(`${API_BASE}/api/save-embeddings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, template, enable_thinking: enableThinking }),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Save failed');
                }

                const data = await response.json();
                alert(`Embeddings saved to: ${data.path}`);
            } catch (err) {
                alert('Failed to save: ' + err.message);
            }
        });
    </script>
</body>
</html>
