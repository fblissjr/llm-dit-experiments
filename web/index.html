<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z-Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Loading animation */
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Smooth transitions */
        .panel-transition { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* History thumbnail hover */
        .history-item:hover .history-overlay { opacity: 1; }
        .history-overlay { transition: opacity 0.2s ease; }

        /* Mobile bottom sheet */
        @media (max-width: 768px) {
            .history-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 60vh;
                border-radius: 1rem 1rem 0 0;
                z-index: 50;
            }
            .history-panel.collapsed {
                max-height: 48px;
            }
        }

        /* Prevent body scroll when panel open on mobile */
        body.panel-open { overflow: hidden; }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            button, select, input[type="number"] {
                min-height: 44px;
            }
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            margin-top: -0.375rem;
        }

        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            border: none;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-6 pb-20 md:pb-6 overflow-y-auto">
            <!-- Header -->
            <header class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Z-Image</h1>
                        <p class="text-sm text-gray-400">Text-to-image with Qwen3-4B</p>
                    </div>
                    <button
                        id="historyToggle"
                        class="md:hidden p-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700"
                        aria-label="Toggle history"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Form -->
            <form id="generateForm" class="space-y-4">
                <!-- Prompt -->
                <div>
                    <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Prompt *</label>
                    <textarea
                        id="prompt"
                        rows="6"
                        required
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Describe what you want to generate..."
                    ></textarea>
                </div>

                <!-- Template -->
                <div>
                    <label for="template" class="block text-sm font-medium text-gray-300 mb-2">Template</label>
                    <select id="template" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">None</option>
                    </select>
                </div>

                <!-- Prompt Rewriter (collapsible) -->
                <details class="group" id="rewriterSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Prompt Rewriter (Qwen3)
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-400">Use the loaded Qwen3 model to expand or rewrite your prompt</p>

                        <!-- Mode Toggle -->
                        <div class="flex gap-2">
                            <button type="button" id="rewriterModeTemplate" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white">Template</button>
                            <button type="button" id="rewriterModeCustom" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">Custom</button>
                        </div>

                        <!-- Template Mode -->
                        <div id="rewriterTemplateMode">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewriter Style</label>
                            <select id="rewriterTemplate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">Select a rewriter...</option>
                            </select>
                        </div>

                        <!-- Custom Mode -->
                        <div id="rewriterCustomMode" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custom Instructions</label>
                            <textarea id="customRewriterPrompt" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="Write your own rewriting instructions...&#10;&#10;Example: Expand this into a detailed image description with cinematic lighting and moody atmosphere."></textarea>
                        </div>

                        <!-- Rewriter Controls -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Max Tokens</label>
                                <input type="number" id="rewriterMaxTokens" value="512" min="64" max="2048" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Temperature</label>
                                <input type="number" id="rewriterTemperature" value="0.7" min="0" max="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Rewrite Button -->
                        <button
                            type="button"
                            id="rewriteBtn"
                            class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors text-sm"
                        >
                            Rewrite Prompt
                        </button>

                        <!-- Rewrite Status -->
                        <div id="rewriteStatus" class="hidden">
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <div class="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                <span>Rewriting...</span>
                            </div>
                        </div>

                        <!-- Rewritten Result -->
                        <div id="rewrittenResult" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewritten Prompt</label>
                            <div class="bg-gray-900 rounded-lg p-3 max-h-48 overflow-y-auto">
                                <pre class="text-xs text-gray-300 whitespace-pre-wrap font-mono" id="rewrittenText"></pre>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button
                                    type="button"
                                    id="useRewrittenBtn"
                                    class="flex-1 py-2 px-3 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Use This Prompt
                                </button>
                                <button
                                    type="button"
                                    id="copyRewrittenBtn"
                                    class="py-2 px-3 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Copy to clipboard"
                                >
                                    Copy
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="rewriteInfo"></p>
                        </div>
                    </div>
                </details>

                <!-- Resolution & Steps Row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Resolution Preset -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolution</label>
                        <select id="resolution" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                            <option value="512x512">512 x 512 (Square)</option>
                            <option value="768x768">768 x 768 (Square)</option>
                            <option value="1024x1024" selected>1024 x 1024 (Square)</option>
                            <option value="1280x1280">1280 x 1280 (Square)</option>
                            <option value="1024x768">1024 x 768 (4:3 Landscape)</option>
                            <option value="768x1024">768 x 1024 (3:4 Portrait)</option>
                            <option value="1280x720">1280 x 720 (16:9 Landscape)</option>
                            <option value="720x1280">720 x 1280 (9:16 Portrait)</option>
                            <option value="1024x576">1024 x 576 (16:9 Wide)</option>
                            <option value="576x1024">576 x 1024 (9:16 Tall)</option>
                            <option value="1152x896">1152 x 896 (9:7)</option>
                            <option value="896x1152">896 x 1152 (7:9)</option>
                            <option value="1216x832">1216 x 832 (3:2)</option>
                            <option value="832x1216">832 x 1216 (2:3)</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>

                    <!-- Steps -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Steps: <span id="stepsValue" class="text-blue-400">9</span>
                        </label>
                        <input
                            type="range"
                            id="steps"
                            min="1"
                            max="50"
                            value="9"
                            class="w-full mt-1"
                        >
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 (Fast)</span>
                            <span>50 (Quality)</span>
                        </div>
                    </div>
                </div>

                <!-- Custom Resolution (hidden by default) -->
                <div id="customResolution" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Width</label>
                        <select id="width" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Height</label>
                        <select id="height" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                </div>

                <!-- Seed -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Seed (optional)</label>
                    <input
                        type="number"
                        id="seed"
                        placeholder="Random"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Leave empty for random seed</p>
                </div>

                <!-- Advanced Options (collapsible) -->
                <details class="group" open>
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Chat Template Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- System Prompt -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">System Prompt</label>
                            <textarea
                                id="systemPrompt"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="You are a painter. (optional)"
                            ></textarea>
                        </div>

                        <!-- Enable Thinking -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="enableThinking"
                                checked
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="enableThinking" class="ml-2 text-sm text-gray-300">Enable thinking block</label>
                        </div>

                        <!-- Strip Quotes -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="stripQuotes"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="stripQuotes" class="ml-2 text-sm text-gray-300">Strip quotes from prompt</label>
                            <span class="ml-2 text-xs text-gray-500">(for JSON-type prompts)</span>
                        </div>

                        <!-- Thinking Content -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Thinking Content</label>
                            <textarea
                                id="thinkingContent"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="Leave empty for default (optional)"
                            ></textarea>
                        </div>

                        <!-- Assistant Content -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Assistant Content</label>
                            <input
                                type="text"
                                id="assistantContent"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="Here is your image: (optional)"
                            >
                        </div>
                    </div>
                </details>

                <!-- Scheduler Options (collapsible) -->
                <details class="group">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Scheduler Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- Guidance Scale -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Guidance Scale: <span id="guidanceScaleValue" class="text-blue-400">0.0</span>
                            </label>
                            <input
                                type="range"
                                id="guidanceScale"
                                min="0"
                                max="10"
                                step="0.1"
                                value="0.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.0 (Default for Z-Image Turbo)</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Z-Image Turbo uses 0.0 (CFG baked in via Decoupled-DMD)</p>
                        </div>

                        <!-- Shift -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Scheduler Shift: <span id="shiftValue" class="text-blue-400">3.0</span>
                            </label>
                            <input
                                type="range"
                                id="shift"
                                min="0.5"
                                max="10.0"
                                step="0.1"
                                value="3.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.5</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">FlowMatchEuler scheduler shift parameter (default: 3.0)</p>
                        </div>
                    </div>
                </details>

                <!-- Generate Button -->
                <button
                    type="submit"
                    id="generateBtn"
                    class="w-full py-4 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors text-lg shadow-lg shadow-blue-500/20"
                >
                    Generate
                </button>
            </form>

            <!-- Status/Progress -->
            <div id="status" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <span id="statusText" class="text-gray-300">Generating...</span>
                    </div>
                    <div class="mt-3 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="progressFill" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden mt-4">
                <div class="bg-red-900/30 border border-red-700/50 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-red-300 text-sm" id="errorText"></p>
                    </div>
                </div>
            </div>

            <!-- Result -->
            <div id="result" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl overflow-hidden">
                    <img id="resultImage" class="w-full" alt="Generated image">
                    <div class="p-4">
                        <div class="flex items-center justify-between gap-4 mb-3">
                            <div class="text-sm text-gray-400 truncate flex-1" id="resultInfo"></div>
                            <div class="flex gap-2">
                                <button
                                    id="reuseBtn"
                                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Edit this prompt"
                                >
                                    Edit
                                </button>
                                <a
                                    id="downloadBtn"
                                    download="z-image.png"
                                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Save
                                </a>
                            </div>
                        </div>
                        <!-- Formatted Prompt -->
                        <details class="group">
                            <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-300 flex items-center gap-1 select-none">
                                <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                Show formatted prompt
                            </summary>
                            <div class="mt-2 bg-gray-900 rounded-lg p-3">
                                <pre class="text-xs text-gray-300 overflow-x-auto whitespace-pre-wrap font-mono" id="resultFormattedPrompt">-</pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel -->
        <div id="historyPanel" class="history-panel md:w-80 lg:w-96 bg-gray-800 border-l border-gray-700 md:block hidden collapsed md:!block">
            <!-- Mobile handle -->
            <div class="md:hidden h-12 flex items-center justify-center cursor-pointer" id="historyHandle">
                <div class="w-12 h-1 bg-gray-600 rounded-full"></div>
            </div>

            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="font-semibold text-white">History</h2>
                <button
                    id="clearHistoryBtn"
                    class="text-xs text-gray-400 hover:text-red-400 transition-colors"
                >
                    Clear all
                </button>
            </div>

            <div id="historyList" class="overflow-y-auto p-2" style="max-height: calc(100vh - 120px);">
                <div class="text-center text-gray-500 text-sm py-8">
                    No generations yet
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // DOM Elements
        const form = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const error = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        const result = document.getElementById('result');
        const resultImage = document.getElementById('resultImage');
        const resultInfo = document.getElementById('resultInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const reuseBtn = document.getElementById('reuseBtn');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const historyToggle = document.getElementById('historyToggle');
        const historyHandle = document.getElementById('historyHandle');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const resolutionSelect = document.getElementById('resolution');
        const customResolution = document.getElementById('customResolution');
        const widthSelect = document.getElementById('width');
        const heightSelect = document.getElementById('height');
        const stepsSlider = document.getElementById('steps');
        const stepsValue = document.getElementById('stepsValue');
        const guidanceScaleSlider = document.getElementById('guidanceScale');
        const guidanceScaleValue = document.getElementById('guidanceScaleValue');
        const shiftSlider = document.getElementById('shift');
        const shiftValue = document.getElementById('shiftValue');

        // Current generation params (for reuse)
        let currentParams = null;

        // Update slider value displays
        stepsSlider.addEventListener('input', () => {
            stepsValue.textContent = stepsSlider.value;
        });

        guidanceScaleSlider.addEventListener('input', () => {
            guidanceScaleValue.textContent = parseFloat(guidanceScaleSlider.value).toFixed(1);
        });

        shiftSlider.addEventListener('input', () => {
            shiftValue.textContent = parseFloat(shiftSlider.value).toFixed(1);
        });

        // Populate width/height dropdowns with multiples of 16
        function populateResolutionDropdowns() {
            const sizes = [];
            for (let s = 256; s <= 2048; s += 16) {
                sizes.push(s);
            }
            [widthSelect, heightSelect].forEach(select => {
                select.innerHTML = sizes.map(s =>
                    `<option value="${s}" ${s === 1024 ? 'selected' : ''}>${s}</option>`
                ).join('');
            });
        }
        populateResolutionDropdowns();

        // Resolution preset handling
        resolutionSelect.addEventListener('change', () => {
            if (resolutionSelect.value === 'custom') {
                customResolution.classList.remove('hidden');
            } else {
                customResolution.classList.add('hidden');
                const [w, h] = resolutionSelect.value.split('x').map(Number);
                widthSelect.value = w;
                heightSelect.value = h;
            }
        });

        // History panel toggle (mobile)
        function toggleHistoryPanel() {
            historyPanel.classList.toggle('collapsed');
            historyPanel.classList.toggle('hidden');
            document.body.classList.toggle('panel-open', !historyPanel.classList.contains('collapsed'));
        }
        historyToggle?.addEventListener('click', toggleHistoryPanel);
        historyHandle?.addEventListener('click', toggleHistoryPanel);

        // Store template data for auto-population
        let templateData = {};

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates`);
                const data = await response.json();
                const select = document.getElementById('template');
                select.innerHTML = '<option value="">None (raw prompt)</option>';

                // Group templates by category
                const categories = {};
                data.templates.forEach(t => {
                    templateData[t.name] = t;
                    const cat = t.category || 'general';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(t);
                });

                // Add options grouped by category
                Object.keys(categories).sort().forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.charAt(0).toUpperCase() + cat.slice(1);
                    categories[cat].forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.name;
                        opt.textContent = t.name.replace(/^z_image_/, '').replace(/_/g, ' ');
                        if (t.thinking_content) opt.textContent += ' *';
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                });

                // Add template change listener
                select.addEventListener('change', onTemplateChange);
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }

        // Handle template selection - auto-populate fields
        function onTemplateChange(e) {
            const name = e.target.value;
            const systemPromptEl = document.getElementById('systemPrompt');
            const thinkingContentEl = document.getElementById('thinkingContent');
            const assistantContentEl = document.getElementById('assistantContent');
            const enableThinkingEl = document.getElementById('enableThinking');

            if (!name || !templateData[name]) {
                // Clear fields if no template selected
                systemPromptEl.value = '';
                thinkingContentEl.value = '';
                assistantContentEl.value = '';
                enableThinkingEl.checked = false;
                return;
            }

            const t = templateData[name];
            systemPromptEl.value = t.system_prompt || '';
            thinkingContentEl.value = t.thinking_content || '';
            assistantContentEl.value = t.assistant_content || '';
            enableThinkingEl.checked = t.add_think_block || false;
        }

        // Rewriter mode toggle
        let rewriterMode = 'template'; // 'template' or 'custom'

        function setupRewriterModeToggle() {
            const templateBtn = document.getElementById('rewriterModeTemplate');
            const customBtn = document.getElementById('rewriterModeCustom');
            const templateMode = document.getElementById('rewriterTemplateMode');
            const customMode = document.getElementById('rewriterCustomMode');

            templateBtn.addEventListener('click', () => {
                rewriterMode = 'template';
                templateBtn.classList.remove('bg-gray-700', 'text-gray-300');
                templateBtn.classList.add('bg-blue-600', 'text-white');
                customBtn.classList.remove('bg-blue-600', 'text-white');
                customBtn.classList.add('bg-gray-700', 'text-gray-300');
                templateMode.classList.remove('hidden');
                customMode.classList.add('hidden');
            });

            customBtn.addEventListener('click', () => {
                rewriterMode = 'custom';
                customBtn.classList.remove('bg-gray-700', 'text-gray-300');
                customBtn.classList.add('bg-blue-600', 'text-white');
                templateBtn.classList.remove('bg-blue-600', 'text-white');
                templateBtn.classList.add('bg-gray-700', 'text-gray-300');
                customMode.classList.remove('hidden');
                templateMode.classList.add('hidden');
            });
        }

        // Load rewriters
        async function loadRewriters() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriters`);
                const data = await response.json();
                const select = document.getElementById('rewriterTemplate');
                select.innerHTML = '<option value="">Select a rewriter...</option>';

                if (data.rewriters && data.rewriters.length > 0) {
                    data.rewriters.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.name;
                        opt.textContent = r.description || r.name;
                        select.appendChild(opt);
                    });
                }
                // Always setup mode toggle (custom mode always available)
                setupRewriterModeToggle();
            } catch (err) {
                console.error('Failed to load rewriters:', err);
                // Still setup mode toggle for custom mode
                setupRewriterModeToggle();
            }
        }

        // Rewrite prompt
        const rewriteBtn = document.getElementById('rewriteBtn');
        const rewriteStatus = document.getElementById('rewriteStatus');
        const rewrittenResult = document.getElementById('rewrittenResult');
        const rewrittenText = document.getElementById('rewrittenText');
        const rewriteInfo = document.getElementById('rewriteInfo');
        const useRewrittenBtn = document.getElementById('useRewrittenBtn');
        const copyRewrittenBtn = document.getElementById('copyRewrittenBtn');

        let lastRewrittenPrompt = '';

        rewriteBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('prompt').value.trim();
            const rewriter = document.getElementById('rewriterTemplate').value;
            const customPrompt = document.getElementById('customRewriterPrompt').value.trim();
            const maxTokens = parseInt(document.getElementById('rewriterMaxTokens').value) || 512;
            const temperature = parseFloat(document.getElementById('rewriterTemperature').value) || 0.7;

            if (!prompt) {
                alert('Please enter a prompt first');
                return;
            }

            // Validate based on mode
            if (rewriterMode === 'template' && !rewriter) {
                alert('Please select a rewriter style');
                return;
            }
            if (rewriterMode === 'custom' && !customPrompt) {
                alert('Please enter custom rewriting instructions');
                return;
            }

            // Show status
            rewriteBtn.disabled = true;
            rewriteStatus.classList.remove('hidden');
            rewrittenResult.classList.add('hidden');

            try {
                // Build request based on mode
                const requestBody = {
                    prompt,
                    max_tokens: maxTokens,
                    temperature,
                };

                if (rewriterMode === 'template') {
                    requestBody.rewriter = rewriter;
                } else {
                    requestBody.custom_system_prompt = customPrompt;
                }

                const response = await fetch(`${API_BASE}/api/rewrite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Rewrite failed');
                }

                const data = await response.json();
                lastRewrittenPrompt = data.rewritten_prompt;
                rewrittenText.textContent = data.rewritten_prompt;
                const modeLabel = rewriterMode === 'custom' ? 'custom prompt' : data.rewriter;
                rewriteInfo.textContent = `Generated in ${data.gen_time.toFixed(2)}s using ${modeLabel}`;
                rewrittenResult.classList.remove('hidden');

            } catch (err) {
                alert('Rewrite failed: ' + err.message);
            } finally {
                rewriteBtn.disabled = false;
                rewriteStatus.classList.add('hidden');
            }
        });

        // Use rewritten prompt
        useRewrittenBtn.addEventListener('click', () => {
            if (lastRewrittenPrompt) {
                document.getElementById('prompt').value = lastRewrittenPrompt;
                // Scroll to prompt
                document.getElementById('prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('prompt').focus();
            }
        });

        // Copy rewritten prompt
        copyRewrittenBtn.addEventListener('click', async () => {
            if (lastRewrittenPrompt) {
                try {
                    await navigator.clipboard.writeText(lastRewrittenPrompt);
                    const originalText = copyRewrittenBtn.textContent;
                    copyRewrittenBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyRewrittenBtn.textContent = originalText;
                    }, 1500);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            }
        });

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/history`);
                const data = await response.json();
                renderHistory(data.history);
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        // Render history
        function renderHistory(history) {
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">No generations yet</div>';
                return;
            }

            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item relative rounded-lg overflow-hidden mb-2 cursor-pointer group" data-index="${index}">
                    <img src="data:image/png;base64,${item.image_b64}" class="w-full aspect-square object-cover" alt="Generated">
                    <div class="history-overlay absolute inset-0 bg-black/60 opacity-0 flex flex-col justify-end p-2">
                        <p class="text-white text-xs line-clamp-2 mb-1">${escapeHtml(item.prompt.substring(0, 80))}${item.prompt.length > 80 ? '...' : ''}</p>
                        <div class="flex gap-1">
                            <button class="history-reuse flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                Use
                            </button>
                            <button class="history-delete px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                                X
                            </button>
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 text-xs text-white/70 bg-black/50 px-1 rounded">
                        ${item.width}x${item.height}
                    </div>
                </div>
            `).join('');

            // Add event listeners
            historyList.querySelectorAll('.history-reuse').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    reuseHistoryItem(history[index]);
                });
            });

            historyList.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    await deleteHistoryItem(index);
                });
            });

            historyList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    showHistoryItemFull(history[index]);
                });
            });
        }

        // Reuse history item
        function reuseHistoryItem(item) {
            document.getElementById('prompt').value = item.prompt;
            document.getElementById('systemPrompt').value = item.system_prompt || '';
            document.getElementById('thinkingContent').value = item.thinking_content || '';
            document.getElementById('assistantContent').value = item.assistant_content || '';
            document.getElementById('enableThinking').checked = item.force_think_block || false;
            document.getElementById('stripQuotes').checked = item.strip_quotes || false;
            document.getElementById('seed').value = item.seed || '';
            document.getElementById('template').value = item.template || '';

            // Set steps
            stepsSlider.value = item.steps || 9;
            stepsValue.textContent = stepsSlider.value;

            // Set guidance_scale and shift if they exist
            if (item.guidance_scale !== undefined) {
                guidanceScaleSlider.value = item.guidance_scale;
                guidanceScaleValue.textContent = parseFloat(item.guidance_scale).toFixed(1);
            }
            if (item.shift !== undefined) {
                shiftSlider.value = item.shift;
                shiftValue.textContent = parseFloat(item.shift).toFixed(1);
            }

            // Set resolution
            const resValue = `${item.width}x${item.height}`;
            const resOption = [...resolutionSelect.options].find(o => o.value === resValue);
            if (resOption) {
                resolutionSelect.value = resValue;
                customResolution.classList.add('hidden');
            } else {
                resolutionSelect.value = 'custom';
                customResolution.classList.remove('hidden');
                widthSelect.value = item.width;
                heightSelect.value = item.height;
            }

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }

            // Scroll to top and focus prompt
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('prompt').focus();
        }

        // Show full history item in result area
        function showHistoryItemFull(item) {
            resultImage.src = `data:image/png;base64,${item.image_b64}`;
            downloadBtn.href = `data:image/png;base64,${item.image_b64}`;

            let infoText = `${item.width}x${item.height}, ${item.steps} steps, ${item.gen_time.toFixed(1)}s`;
            if (item.guidance_scale !== undefined && item.guidance_scale !== 0) {
                infoText += `, CFG ${item.guidance_scale}`;
            }
            if (item.shift !== undefined && item.shift !== 3.0) {
                infoText += `, shift ${item.shift}`;
            }

            resultInfo.textContent = infoText;
            document.getElementById('resultFormattedPrompt').textContent = item.formatted_prompt || '-';

            currentParams = item;
            result.classList.remove('hidden');

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }
        }

        // Delete history item
        async function deleteHistoryItem(index) {
            try {
                await fetch(`${API_BASE}/api/history/${index}`, { method: 'DELETE' });
                loadHistory();
            } catch (err) {
                console.error('Failed to delete:', err);
            }
        }

        // Clear all history
        clearHistoryBtn.addEventListener('click', async () => {
            if (confirm('Clear all history?')) {
                try {
                    await fetch(`${API_BASE}/api/history`, { method: 'DELETE' });
                    loadHistory();
                } catch (err) {
                    console.error('Failed to clear:', err);
                }
            }
        });

        // Reuse button
        reuseBtn.addEventListener('click', () => {
            if (currentParams) {
                reuseHistoryItem(currentParams);
            }
        });

        // Get current resolution
        function getResolution() {
            if (resolutionSelect.value === 'custom') {
                return {
                    width: parseInt(widthSelect.value),
                    height: parseInt(heightSelect.value)
                };
            }
            const [w, h] = resolutionSelect.value.split('x').map(Number);
            return { width: w, height: h };
        }

        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const { width, height } = getResolution();

            // Reset UI
            status.classList.remove('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
            generateBtn.disabled = true;
            progressFill.style.width = '10%';
            statusText.textContent = 'Starting...';

            const params = {
                prompt: document.getElementById('prompt').value,
                system_prompt: document.getElementById('systemPrompt').value || null,
                thinking_content: document.getElementById('thinkingContent').value || null,
                assistant_content: document.getElementById('assistantContent').value || null,
                force_think_block: document.getElementById('enableThinking').checked,
                strip_quotes: document.getElementById('stripQuotes').checked,
                template: document.getElementById('template').value || null,
                width,
                height,
                steps: parseInt(stepsSlider.value),
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
                guidance_scale: parseFloat(guidanceScaleSlider.value),
                shift: parseFloat(shiftSlider.value),
            };

            currentParams = params;

            try {
                progressFill.style.width = '20%';
                statusText.textContent = 'Formatting prompt...';

                // Get formatted prompt first (fast, no GPU)
                const formatResponse = await fetch(`${API_BASE}/api/format-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });
                let formattedPrompt = '-';
                if (formatResponse.ok) {
                    const formatData = await formatResponse.json();
                    formattedPrompt = formatData.formatted_prompt || '-';
                }

                progressFill.style.width = '30%';
                statusText.textContent = 'Generating...';

                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Generation failed');
                }

                progressFill.style.width = '70%';
                statusText.textContent = 'Processing...';

                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                const genTime = response.headers.get('X-Generation-Time');
                const seed = response.headers.get('X-Seed');

                resultImage.src = imageUrl;
                downloadBtn.href = imageUrl;

                let infoText = `${width}x${height}, ${params.steps} steps${genTime ? `, ${parseFloat(genTime).toFixed(1)}s` : ''}${seed && seed !== 'random' ? `, seed ${seed}` : ''}`;
                if (params.guidance_scale !== 0) {
                    infoText += `, CFG ${params.guidance_scale}`;
                }
                if (params.shift !== 3.0) {
                    infoText += `, shift ${params.shift}`;
                }

                resultInfo.textContent = infoText;
                document.getElementById('resultFormattedPrompt').textContent = formattedPrompt;

                status.classList.add('hidden');
                result.classList.remove('hidden');
                progressFill.style.width = '100%';

                // Reload history
                loadHistory();

            } catch (err) {
                status.classList.add('hidden');
                error.classList.remove('hidden');
                errorText.textContent = err.message;
            } finally {
                generateBtn.disabled = false;
            }
        });

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadTemplates();
        loadRewriters();
        loadHistory();
    </script>
</body>
</html>
