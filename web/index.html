<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Z-Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Loading animation */
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Smooth transitions */
        .panel-transition { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* History thumbnail hover */
        .history-item:hover .history-overlay { opacity: 1; }
        .history-overlay { transition: opacity 0.2s ease; }

        /* Mobile bottom sheet */
        @media (max-width: 768px) {
            .history-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 60vh;
                border-radius: 1rem 1rem 0 0;
                z-index: 50;
            }
            .history-panel.collapsed {
                max-height: 48px;
            }
        }

        /* Prevent body scroll when panel open on mobile */
        body.panel-open { overflow: hidden; }

        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            button, select, input[type="number"] {
                min-height: 44px;
            }
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            margin-top: -0.375rem;
        }

        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 50%;
            border: none;
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-6 pb-20 md:pb-6 overflow-y-auto">
            <!-- Header -->
            <header class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white">Z-Image</h1>
                        <p class="text-sm text-gray-400">Text-to-image with Qwen3-4B</p>
                    </div>
                    <button
                        id="historyToggle"
                        class="md:hidden p-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700"
                        aria-label="Toggle history"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Form -->
            <form id="generateForm" class="space-y-4">
                <!-- Prompt -->
                <div>
                    <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Prompt *</label>
                    <textarea
                        id="prompt"
                        rows="6"
                        required
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Describe what you want to generate..."
                    ></textarea>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500">Token count updates when you stop typing</p>
                        <p id="tokenCount" class="text-xs text-gray-400">-- / 1504 tokens</p>
                    </div>
                </div>

                <!-- Template -->
                <div>
                    <label for="template" class="block text-sm font-medium text-gray-300 mb-2">Template</label>
                    <select id="template" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        <option value="">None</option>
                    </select>
                </div>

                <!-- Prompt Rewriter (collapsible) -->
                <details class="group" id="rewriterSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Prompt Rewriter (Qwen3)
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-400">Use the loaded Qwen3 model to expand or rewrite your prompt</p>

                        <!-- Mode Toggle -->
                        <div class="flex gap-2">
                            <button type="button" id="rewriterModeTemplate" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white">Template</button>
                            <button type="button" id="rewriterModeCustom" class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600">Custom</button>
                        </div>

                        <!-- Model Selector -->
                        <div id="rewriterModelContainer">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                            <select id="rewriterModel" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="qwen3-4b">Qwen3-4B (Text)</option>
                                <!-- VL option added dynamically if available -->
                            </select>
                        </div>

                        <!-- VL Image Upload (hidden by default, shown when VL model selected) -->
                        <div id="rewriterImageUpload" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Reference Image <span class="text-gray-500">(optional)</span></label>
                            <div id="rewriterDropzone" class="relative border-2 border-dashed border-gray-600 rounded-lg p-3 text-center cursor-pointer hover:border-purple-500 hover:bg-gray-800/50 transition-colors">
                                <input type="file" id="rewriterImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <div id="rewriterDropzoneContent">
                                    <svg class="w-6 h-6 mx-auto text-gray-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-xs text-gray-400">Drop image or click to upload</p>
                                </div>
                                <!-- Image Preview -->
                                <div id="rewriterImagePreview" class="hidden">
                                    <img id="rewriterPreviewImg" class="max-h-20 mx-auto rounded-lg" alt="Rewriter reference image">
                                    <button type="button" id="rewriterClearImage" class="mt-2 text-xs text-red-400 hover:text-red-300">Clear</button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Use an image as input for VL rewriting</p>
                        </div>

                        <!-- Template Mode -->
                        <div id="rewriterTemplateMode">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewriter Style</label>
                            <select id="rewriterTemplate" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">Select a rewriter...</option>
                            </select>
                        </div>

                        <!-- Custom Mode -->
                        <div id="rewriterCustomMode" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custom Instructions</label>
                            <textarea id="customRewriterPrompt" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm resize-none" placeholder="Write your own rewriting instructions...&#10;&#10;Example: Expand this into a detailed image description with cinematic lighting and moody atmosphere."></textarea>
                        </div>

                        <!-- Rewriter Controls -->
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Max Tokens</label>
                                <input type="number" id="rewriterMaxTokens" value="512" min="64" max="2048" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Temperature</label>
                                <input type="number" id="rewriterTemperature" value="0.6" min="0" max="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Top P</label>
                                <input type="number" id="rewriterTopP" value="0.95" min="0" max="1" step="0.05" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Top K</label>
                                <input type="number" id="rewriterTopK" value="20" min="0" max="100" step="1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Min P</label>
                                <input type="number" id="rewriterMinP" value="0.0" min="0" max="1" step="0.05" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Presence Pen.</label>
                                <input type="number" id="rewriterPresencePenalty" value="0.0" min="0" max="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Rewrite Button -->
                        <button
                            type="button"
                            id="rewriteBtn"
                            class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors text-sm"
                        >
                            Rewrite Prompt
                        </button>

                        <!-- Rewrite Status -->
                        <div id="rewriteStatus" class="hidden">
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <div class="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                <span>Rewriting...</span>
                            </div>
                        </div>

                        <!-- Rewritten Result -->
                        <div id="rewrittenResult" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Rewritten Prompt</label>
                            <div class="bg-gray-900 rounded-lg p-3 max-h-48 overflow-y-auto">
                                <pre class="text-xs text-gray-300 whitespace-pre-wrap font-mono" id="rewrittenText"></pre>
                            </div>
                            <!-- Extracted Thinking Content -->
                            <div id="extractedThinkingResult" class="hidden mt-3">
                                <label class="block text-sm font-medium text-purple-400 mb-2">Extracted Thinking Content</label>
                                <div class="bg-purple-900/30 border border-purple-700 rounded-lg p-3 max-h-32 overflow-y-auto">
                                    <pre class="text-xs text-purple-300 whitespace-pre-wrap font-mono" id="extractedThinkingText"></pre>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button
                                    type="button"
                                    id="useRewrittenBtn"
                                    class="flex-1 py-2 px-3 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Use This Prompt
                                </button>
                                <button
                                    type="button"
                                    id="copyRewrittenBtn"
                                    class="py-2 px-3 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Copy to clipboard"
                                >
                                    Copy
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="rewriteInfo"></p>
                        </div>
                    </div>
                </details>

                <!-- Vision Conditioning (Qwen3-VL) - collapsible -->
                <details class="group" id="vlSection">
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Vision Conditioning (Qwen3-VL)
                        <span id="vlStatusBadge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">Checking...</span>
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-400">Use a reference image to influence the generated style/content</p>

                        <!-- VL Not Available Warning -->
                        <div id="vlNotAvailable" class="hidden bg-yellow-900/30 border border-yellow-700 rounded-lg p-3">
                            <p class="text-xs text-yellow-300">Qwen3-VL not configured. Set vl.model_path in config.toml to enable vision conditioning.</p>
                        </div>

                        <!-- VL Controls (shown when available) -->
                        <div id="vlControls">
                            <!-- Image Upload -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Reference Image</label>
                                <div id="vlDropzone" class="relative border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-800/50 transition-colors">
                                    <input type="file" id="vlImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                    <div id="vlDropzoneContent">
                                        <svg class="w-8 h-8 mx-auto text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <p class="text-sm text-gray-400">Drop image here or click to upload</p>
                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 2048x2048</p>
                                    </div>
                                    <!-- Image Preview (hidden by default) -->
                                    <div id="vlImagePreview" class="hidden">
                                        <img id="vlPreviewImg" class="max-h-32 mx-auto rounded-lg" alt="Reference image">
                                        <p id="vlImageInfo" class="text-xs text-gray-400 mt-2"></p>
                                    </div>
                                </div>
                                <button type="button" id="vlClearImage" class="hidden mt-2 text-xs text-red-400 hover:text-red-300">Clear image</button>
                            </div>

                            <!-- Alpha Slider -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    VL Influence: <span id="vlAlphaValue" class="text-blue-400">0.3</span>
                                </label>
                                <input type="range" id="vlAlpha" min="0" max="1" step="0.05" value="0.3" class="w-full">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0.0 (Text only)</span>
                                    <span>1.0 (VL only)</span>
                                </div>
                            </div>

                            <!-- Presets -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Presets</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button type="button" data-alpha="0.2" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                        Style (0.2)
                                    </button>
                                    <button type="button" data-alpha="0.3" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-blue-600 text-white transition-colors">
                                        Balanced (0.3)
                                    </button>
                                    <button type="button" data-alpha="0.5" class="vl-preset px-3 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                        Strong (0.5)
                                    </button>
                                </div>
                            </div>

                            <!-- Blend Mode -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Blend Mode</label>
                                <select id="vlBlendMode" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="linear">Linear (default)</option>
                                    <option value="style_only">Style Only (preserves text content)</option>
                                    <option value="graduated">Graduated (more VL for later tokens)</option>
                                    <option value="attention_weighted">Attention Weighted (experimental)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Linear blends uniformly. Style Only preserves subject/content from text.</p>
                            </div>

                            <!-- Advanced Options -->
                            <details class="group/vl-adv">
                                <summary class="cursor-pointer text-xs font-medium text-gray-500 hover:text-gray-400 flex items-center gap-1 select-none">
                                    <svg class="w-3 h-3 transition-transform group-open/vl-adv:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    Advanced Options
                                </summary>
                                <div class="mt-3 space-y-3 pl-4 border-l border-gray-700">
                                    <!-- Hidden Layer -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1">
                                            VL Hidden Layer: <span id="vlHiddenLayerValue" class="text-blue-400">-2</span>
                                        </label>
                                        <input type="range" id="vlHiddenLayer" min="-6" max="-1" value="-2" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>-6 (Early)</span>
                                            <span>-1 (Last)</span>
                                        </div>
                                    </div>

                                    <!-- Image Tokens Only -->
                                    <div class="flex items-center">
                                        <input type="checkbox" id="vlImageTokensOnly" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2">
                                        <label for="vlImageTokensOnly" class="ml-2 text-xs text-gray-400">Image tokens only</label>
                                    </div>

                                    <!-- VL Text Description -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1">VL Text (optional)</label>
                                        <input type="text" id="vlText" class="w-full px-2 py-1.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-xs focus:ring-2 focus:ring-blue-500" placeholder="Description with reference image">
                                        <p class="text-xs text-gray-500 mt-1">Text to process along with the image</p>
                                    </div>
                                </div>
                            </details>

                            <!-- Extract Status -->
                            <div id="vlExtractStatus" class="hidden mt-3">
                                <div class="flex items-center gap-2 text-sm text-gray-400">
                                    <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                    <span>Extracting VL embeddings...</span>
                                </div>
                            </div>

                            <!-- Extracted Embeddings Info -->
                            <div id="vlExtractedInfo" class="hidden mt-3 bg-green-900/20 border border-green-700 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-green-400 font-medium">Embeddings Ready</p>
                                        <p id="vlExtractedDetails" class="text-xs text-gray-400 mt-1"></p>
                                    </div>
                                    <button type="button" id="vlClearEmbeddings" class="text-xs text-red-400 hover:text-red-300">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Resolution & Steps Row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Resolution Preset -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolution</label>
                        <select id="resolution" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                            <option value="512x512">512 x 512 (Square)</option>
                            <option value="768x768">768 x 768 (Square)</option>
                            <option value="1024x1024" selected>1024 x 1024 (Square)</option>
                            <option value="1280x1280">1280 x 1280 (Square)</option>
                            <option value="1024x768">1024 x 768 (4:3 Landscape)</option>
                            <option value="768x1024">768 x 1024 (3:4 Portrait)</option>
                            <option value="1280x720">1280 x 720 (16:9 Landscape)</option>
                            <option value="720x1280">720 x 1280 (9:16 Portrait)</option>
                            <option value="1024x576">1024 x 576 (16:9 Wide)</option>
                            <option value="576x1024">576 x 1024 (9:16 Tall)</option>
                            <option value="1152x896">1152 x 896 (9:7)</option>
                            <option value="896x1152">896 x 1152 (7:9)</option>
                            <option value="1216x832">1216 x 832 (3:2)</option>
                            <option value="832x1216">832 x 1216 (2:3)</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>

                    <!-- Steps -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Steps: <span id="stepsValue" class="text-blue-400">9</span>
                        </label>
                        <input
                            type="range"
                            id="steps"
                            min="1"
                            max="50"
                            value="9"
                            class="w-full mt-1"
                        >
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1 (Fast)</span>
                            <span>50 (Quality)</span>
                        </div>
                    </div>
                </div>

                <!-- Custom Resolution (hidden by default) -->
                <div id="customResolution" class="hidden grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Width</label>
                        <select id="width" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Height</label>
                        <select id="height" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                </div>

                <!-- Seed -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Seed (optional)</label>
                    <input
                        type="number"
                        id="seed"
                        placeholder="Random"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Leave empty for random seed</p>
                </div>

                <!-- Advanced Options (collapsible) -->
                <details class="group" open>
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Chat Template Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- System Prompt -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">System Prompt</label>
                            <textarea
                                id="systemPrompt"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="You are a painter. (optional)"
                            ></textarea>
                        </div>

                        <!-- Strip Quotes -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="stripQuotes"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="stripQuotes" class="ml-2 text-sm text-gray-300">Strip quotes from prompt</label>
                            <span class="ml-2 text-xs text-gray-500">(for JSON-type prompts)</span>
                        </div>

                        <!-- Add Think Block -->
                        <div class="flex items-center">
                            <input
                                type="checkbox"
                                id="enableThinking"
                                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 focus:ring-2"
                            >
                            <label for="enableThinking" class="ml-2 text-sm text-gray-300">Add think block</label>
                            <span class="ml-2 text-xs text-gray-500">(default: off, matching HF Space)</span>
                        </div>

                        <!-- Thinking Content (shown when think block enabled) -->
                        <div id="thinkingContentWrapper" class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Thinking Content</label>
                            <textarea
                                id="thinkingContent"
                                rows="2"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                                placeholder="Content inside <think>...</think> (optional)"
                            ></textarea>
                        </div>

                        <!-- Assistant Content -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Assistant Content</label>
                            <input
                                type="text"
                                id="assistantContent"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 text-sm"
                                placeholder="Here is your image: (optional)"
                            >
                        </div>
                    </div>
                </details>

                <!-- Scheduler Options (collapsible) -->
                <details class="group" open>
                    <summary class="cursor-pointer text-sm font-medium text-gray-400 hover:text-gray-300 flex items-center gap-2 select-none">
                        <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        Scheduler Options
                    </summary>
                    <div class="mt-3 space-y-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <!-- Guidance Scale -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Guidance Scale: <span id="guidanceScaleValue" class="text-blue-400">0.0</span>
                            </label>
                            <input
                                type="range"
                                id="guidanceScale"
                                min="0"
                                max="10"
                                step="0.1"
                                value="0.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.0 (Default for Z-Image Turbo)</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Z-Image Turbo uses 0.0 (CFG baked in via Decoupled-DMD)</p>
                        </div>

                        <!-- Shift -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Scheduler Shift: <span id="shiftValue" class="text-blue-400">3.0</span>
                            </label>
                            <input
                                type="range"
                                id="shift"
                                min="0.5"
                                max="10.0"
                                step="0.1"
                                value="3.0"
                                class="w-full"
                            >
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.5</span>
                                <span>10.0</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">FlowMatchEuler scheduler shift parameter (default: 3.0)</p>
                        </div>

                        <!-- Long Prompt Mode -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Long Prompt Mode</label>
                            <select id="longPromptMode" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500">
                                <option value="truncate">Truncate (cuts off end)</option>
                                <option value="interpolate" selected>Interpolate (default, smooth resampling)</option>
                                <option value="pool">Pool (local averaging)</option>
                                <option value="attention_pool">Attention Pool (preserve important)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How to handle prompts exceeding 1504 tokens</p>
                        </div>

                        <!-- Hidden Layer -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Hidden Layer: <span id="hiddenLayerValue" class="text-blue-400">-2</span>
                                <span id="hiddenLayerLabel" class="text-gray-500 text-xs ml-1">(Layer 35 of 36)</span>
                            </label>

                            <!-- Layer Presets - Touch-friendly buttons -->
                            <div class="grid grid-cols-4 gap-1.5 mb-3">
                                <button type="button" data-layer="-2" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-blue-600 text-white transition-colors">
                                    -2
                                </button>
                                <button type="button" data-layer="-5" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -5
                                </button>
                                <button type="button" data-layer="-18" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -18
                                </button>
                                <button type="button" data-layer="-30" class="layer-preset px-2 py-2 text-xs font-medium rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors">
                                    -30
                                </button>
                            </div>

                            <!-- Visual Layer Position Indicator -->
                            <div class="relative mb-2">
                                <!-- Layer track - simple gradient from early to late -->
                                <div class="h-5 rounded-lg bg-gradient-to-r from-gray-700 via-gray-600 to-gray-500 relative">
                                    <!-- Layer markers -->
                                    <div class="absolute inset-0 flex justify-between items-center px-1 text-xs text-gray-400">
                                        <span>1</span>
                                        <span>9</span>
                                        <span>18</span>
                                        <span>27</span>
                                        <span>36</span>
                                    </div>
                                </div>
                                <!-- Position indicator -->
                                <div id="layerPositionIndicator" class="absolute top-0 w-1.5 h-5 bg-blue-400 rounded shadow-lg transition-all duration-150" style="left: 94.3%;"></div>
                            </div>

                            <!-- Full Range Slider -->
                            <input type="range" id="hiddenLayer" min="-35" max="-1" value="-2" class="w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>-35 (Layer 1)</span>
                                <span>-1 (Layer 36)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Default is -2. Qwen3-4B has 36 layers total.
                            </p>
                        </div>

                    </div>
                </details>

                <!-- Generate Button -->
                <button
                    type="submit"
                    id="generateBtn"
                    class="w-full py-4 px-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-700 disabled:cursor-not-allowed text-white font-semibold rounded-xl transition-colors text-lg shadow-lg shadow-blue-500/20"
                >
                    Generate
                </button>
            </form>

            <!-- Status/Progress -->
            <div id="status" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <span id="statusText" class="text-gray-300">Generating...</span>
                    </div>
                    <div class="mt-3 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="progressFill" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden mt-4">
                <div class="bg-red-900/30 border border-red-700/50 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-red-300 text-sm" id="errorText"></p>
                    </div>
                </div>
            </div>

            <!-- Result -->
            <div id="result" class="hidden mt-4">
                <div class="bg-gray-800 rounded-xl overflow-hidden">
                    <img id="resultImage" class="w-full" alt="Generated image">
                    <div class="p-4">
                        <div class="flex items-center justify-between gap-4 mb-3">
                            <div class="text-sm text-gray-400 truncate flex-1" id="resultInfo"></div>
                            <div class="flex gap-2">
                                <button
                                    id="reuseBtn"
                                    class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-colors"
                                    title="Edit this prompt"
                                >
                                    Edit
                                </button>
                                <a
                                    id="downloadBtn"
                                    download="z-image.png"
                                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                                >
                                    Save
                                </a>
                            </div>
                        </div>
                        <!-- Formatted Prompt -->
                        <details class="group">
                            <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-300 flex items-center gap-1 select-none">
                                <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                Show formatted prompt
                            </summary>
                            <div class="mt-2 bg-gray-900 rounded-lg p-3">
                                <pre class="text-xs text-gray-300 overflow-x-auto whitespace-pre-wrap font-mono" id="resultFormattedPrompt">-</pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel -->
        <div id="historyPanel" class="history-panel md:w-80 lg:w-96 bg-gray-800 border-l border-gray-700 md:block hidden collapsed md:!block">
            <!-- Mobile handle -->
            <div class="md:hidden h-12 flex items-center justify-center cursor-pointer" id="historyHandle">
                <div class="w-12 h-1 bg-gray-600 rounded-full"></div>
            </div>

            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="font-semibold text-white">History</h2>
                <button
                    id="clearHistoryBtn"
                    class="text-xs text-gray-400 hover:text-red-400 transition-colors"
                >
                    Clear all
                </button>
            </div>

            <div id="historyList" class="overflow-y-auto p-2" style="max-height: calc(100vh - 120px);">
                <div class="text-center text-gray-500 text-sm py-8">
                    No generations yet
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // DOM Elements
        const form = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const error = document.getElementById('error');
        const errorText = document.getElementById('errorText');
        const result = document.getElementById('result');
        const resultImage = document.getElementById('resultImage');
        const resultInfo = document.getElementById('resultInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const reuseBtn = document.getElementById('reuseBtn');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const historyToggle = document.getElementById('historyToggle');
        const historyHandle = document.getElementById('historyHandle');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const resolutionSelect = document.getElementById('resolution');
        const customResolution = document.getElementById('customResolution');
        const widthSelect = document.getElementById('width');
        const heightSelect = document.getElementById('height');
        const stepsSlider = document.getElementById('steps');
        const stepsValue = document.getElementById('stepsValue');
        const guidanceScaleSlider = document.getElementById('guidanceScale');
        const guidanceScaleValue = document.getElementById('guidanceScaleValue');
        const shiftSlider = document.getElementById('shift');
        const shiftValue = document.getElementById('shiftValue');
        const longPromptModeSelect = document.getElementById('longPromptMode');
        const hiddenLayerSlider = document.getElementById('hiddenLayer');
        const hiddenLayerValue = document.getElementById('hiddenLayerValue');
        const hiddenLayerLabel = document.getElementById('hiddenLayerLabel');
        const layerPositionIndicator = document.getElementById('layerPositionIndicator');
        const layerPresetButtons = document.querySelectorAll('.layer-preset');

        // Current generation params (for reuse)
        let currentParams = null;

        // Update slider value displays
        stepsSlider.addEventListener('input', () => {
            stepsValue.textContent = stepsSlider.value;
        });

        guidanceScaleSlider.addEventListener('input', () => {
            guidanceScaleValue.textContent = parseFloat(guidanceScaleSlider.value).toFixed(1);
        });

        shiftSlider.addEventListener('input', () => {
            shiftValue.textContent = parseFloat(shiftSlider.value).toFixed(1);
        });

        // Hidden layer helper functions
        function updateHiddenLayerUI(layer) {
            const l = parseInt(layer);
            // Convert negative index to actual layer number (1-36)
            // -1 = layer 36, -2 = layer 35, ..., -35 = layer 2, -36 = layer 1
            const actualLayer = 37 + l;  // -1 -> 36, -35 -> 2

            hiddenLayerValue.textContent = l;
            hiddenLayerLabel.textContent = `(Layer ${actualLayer} of 36)`;

            // Update position indicator (layer -35 = 0%, layer -1 = 100%)
            const percent = ((l + 35) / 34) * 100;
            layerPositionIndicator.style.left = `${percent}%`;

            // Update preset button styling
            layerPresetButtons.forEach(btn => {
                const btnLayer = parseInt(btn.dataset.layer);
                if (btnLayer === l) {
                    btn.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                }
            });
        }

        hiddenLayerSlider.addEventListener('input', () => {
            updateHiddenLayerUI(hiddenLayerSlider.value);
        });

        // Layer preset buttons
        layerPresetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const layer = btn.dataset.layer;
                hiddenLayerSlider.value = layer;
                updateHiddenLayerUI(layer);
            });
        });

        // Initialize hidden layer UI
        updateHiddenLayerUI(hiddenLayerSlider.value);

        // Toggle thinking content visibility based on checkbox
        const enableThinkingCheckbox = document.getElementById('enableThinking');
        const thinkingContentWrapper = document.getElementById('thinkingContentWrapper');

        function updateThinkingContentVisibility() {
            if (enableThinkingCheckbox.checked) {
                thinkingContentWrapper.classList.remove('hidden');
            } else {
                thinkingContentWrapper.classList.add('hidden');
            }
        }

        enableThinkingCheckbox.addEventListener('change', updateThinkingContentVisibility);

        // Populate width/height dropdowns with multiples of 16
        function populateResolutionDropdowns() {
            const sizes = [];
            for (let s = 256; s <= 2048; s += 16) {
                sizes.push(s);
            }
            [widthSelect, heightSelect].forEach(select => {
                select.innerHTML = sizes.map(s =>
                    `<option value="${s}" ${s === 1024 ? 'selected' : ''}>${s}</option>`
                ).join('');
            });
        }
        populateResolutionDropdowns();

        // Resolution preset handling
        resolutionSelect.addEventListener('change', () => {
            if (resolutionSelect.value === 'custom') {
                customResolution.classList.remove('hidden');
            } else {
                customResolution.classList.add('hidden');
                const [w, h] = resolutionSelect.value.split('x').map(Number);
                widthSelect.value = w;
                heightSelect.value = h;
            }
        });

        // History panel toggle (mobile)
        function toggleHistoryPanel() {
            historyPanel.classList.toggle('collapsed');
            historyPanel.classList.toggle('hidden');
            document.body.classList.toggle('panel-open', !historyPanel.classList.contains('collapsed'));
        }
        historyToggle?.addEventListener('click', toggleHistoryPanel);
        historyHandle?.addEventListener('click', toggleHistoryPanel);

        // Store template data for auto-population
        let templateData = {};

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates`);
                const data = await response.json();
                const select = document.getElementById('template');
                select.innerHTML = '<option value="">None (raw prompt)</option>';

                // Group templates by category
                const categories = {};
                data.templates.forEach(t => {
                    templateData[t.name] = t;
                    const cat = t.category || 'general';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(t);
                });

                // Add options grouped by category
                Object.keys(categories).sort().forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.charAt(0).toUpperCase() + cat.slice(1);
                    categories[cat].forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.name;
                        opt.textContent = t.name.replace(/^z_image_/, '').replace(/_/g, ' ');
                        if (t.thinking_content) opt.textContent += ' *';
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                });

                // Add template change listener
                select.addEventListener('change', onTemplateChange);
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }

        // Handle template selection - auto-populate fields
        function onTemplateChange(e) {
            const name = e.target.value;
            const systemPromptEl = document.getElementById('systemPrompt');
            const thinkingContentEl = document.getElementById('thinkingContent');
            const assistantContentEl = document.getElementById('assistantContent');
            const enableThinkingEl = document.getElementById('enableThinking');

            if (!name || !templateData[name]) {
                // Clear fields if no template selected
                systemPromptEl.value = '';
                thinkingContentEl.value = '';
                assistantContentEl.value = '';
                enableThinkingEl.checked = false;
                updateThinkingContentVisibility();
                return;
            }

            const t = templateData[name];

            // Always populate system prompt (the main template content)
            systemPromptEl.value = t.system_prompt || '';

            // Populate thinking content if template has it
            if (t.thinking_content) {
                thinkingContentEl.value = t.thinking_content;
                enableThinkingEl.checked = true;  // Auto-check if template has thinking content
            }
            // Don't clear thinking content or uncheck if template doesn't have it
            // This preserves user's manual input

            // Populate assistant content if template has it
            if (t.assistant_content) {
                assistantContentEl.value = t.assistant_content;
            }

            // Only explicitly check/uncheck if template specifies add_think_block: true
            if (t.add_think_block === true) {
                enableThinkingEl.checked = true;
            }

            // Update thinking content visibility based on checkbox state
            updateThinkingContentVisibility();
        }

        // Rewriter mode toggle
        let rewriterMode = 'template'; // 'template' or 'custom'

        function setupRewriterModeToggle() {
            const templateBtn = document.getElementById('rewriterModeTemplate');
            const customBtn = document.getElementById('rewriterModeCustom');
            const templateMode = document.getElementById('rewriterTemplateMode');
            const customMode = document.getElementById('rewriterCustomMode');

            templateBtn.addEventListener('click', () => {
                rewriterMode = 'template';
                templateBtn.classList.remove('bg-gray-700', 'text-gray-300');
                templateBtn.classList.add('bg-blue-600', 'text-white');
                customBtn.classList.remove('bg-blue-600', 'text-white');
                customBtn.classList.add('bg-gray-700', 'text-gray-300');
                templateMode.classList.remove('hidden');
                customMode.classList.add('hidden');
            });

            customBtn.addEventListener('click', () => {
                rewriterMode = 'custom';
                customBtn.classList.remove('bg-gray-700', 'text-gray-300');
                customBtn.classList.add('bg-blue-600', 'text-white');
                templateBtn.classList.remove('bg-blue-600', 'text-white');
                templateBtn.classList.add('bg-gray-700', 'text-gray-300');
                customMode.classList.remove('hidden');
                templateMode.classList.add('hidden');
            });
        }

        // Load rewriter config from server
        async function loadRewriterConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriter-config`);
                const config = await response.json();
                // Update form fields with server config defaults
                document.getElementById('rewriterMaxTokens').value = config.max_tokens || 512;
                document.getElementById('rewriterTemperature').value = config.temperature || 0.6;
                document.getElementById('rewriterTopP').value = config.top_p || 0.95;
                document.getElementById('rewriterTopK').value = config.top_k || 20;
                document.getElementById('rewriterMinP').value = config.min_p || 0.0;
                document.getElementById('rewriterPresencePenalty').value = config.presence_penalty || 0.0;
            } catch (err) {
                console.error('Failed to load rewriter config:', err);
            }
        }

        // Load rewriters
        async function loadRewriters() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriters`);
                const data = await response.json();
                const select = document.getElementById('rewriterTemplate');
                select.innerHTML = '<option value="">Select a rewriter...</option>';

                if (data.rewriters && data.rewriters.length > 0) {
                    data.rewriters.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.name;
                        opt.textContent = r.description || r.name;
                        select.appendChild(opt);
                    });
                }
                // Always setup mode toggle (custom mode always available)
                setupRewriterModeToggle();
                // Load config defaults after rewriters
                loadRewriterConfig();
            } catch (err) {
                console.error('Failed to load rewriters:', err);
                // Still setup mode toggle for custom mode
                setupRewriterModeToggle();
                // Still try to load config
                loadRewriterConfig();
            }
        }

        // Rewrite prompt
        const rewriteBtn = document.getElementById('rewriteBtn');
        const rewriteStatus = document.getElementById('rewriteStatus');
        const rewrittenResult = document.getElementById('rewrittenResult');
        const rewrittenText = document.getElementById('rewrittenText');
        const rewriteInfo = document.getElementById('rewriteInfo');
        const useRewrittenBtn = document.getElementById('useRewrittenBtn');
        const copyRewrittenBtn = document.getElementById('copyRewrittenBtn');

        let lastRewrittenPrompt = '';
        let lastThinkingContent = null;

        // Rewriter model and image state
        let rewriterModels = [];
        let rewriterImageBase64 = null;

        // Load available rewriter models
        async function loadRewriterModels() {
            try {
                const response = await fetch(`${API_BASE}/api/rewriter-models`);
                const data = await response.json();
                rewriterModels = data.models;

                const select = document.getElementById('rewriterModel');
                select.innerHTML = data.models.map(m =>
                    `<option value="${m.id}">${m.name}${m.loaded ? ' (loaded)' : ''}</option>`
                ).join('');

                // Set up model change handler
                select.addEventListener('change', onRewriterModelChange);

                // Initial state check
                onRewriterModelChange();
            } catch (err) {
                console.error('Failed to load rewriter models:', err);
            }
        }

        // Handle rewriter model change - show/hide image upload
        function onRewriterModelChange() {
            const modelId = document.getElementById('rewriterModel').value;
            const model = rewriterModels.find(m => m.id === modelId);
            const imageUpload = document.getElementById('rewriterImageUpload');

            if (model?.supports_image) {
                imageUpload.classList.remove('hidden');
            } else {
                imageUpload.classList.add('hidden');
                rewriterImageBase64 = null;
                clearRewriterImagePreview();
            }
        }

        // Clear rewriter image preview
        function clearRewriterImagePreview() {
            const dropzoneContent = document.getElementById('rewriterDropzoneContent');
            const imagePreview = document.getElementById('rewriterImagePreview');
            dropzoneContent.classList.remove('hidden');
            imagePreview.classList.add('hidden');
            rewriterImageBase64 = null;
        }

        // Set up rewriter image upload handlers
        function setupRewriterImageUpload() {
            const imageInput = document.getElementById('rewriterImageInput');
            const dropzone = document.getElementById('rewriterDropzone');
            const clearBtn = document.getElementById('rewriterClearImage');

            // File input change
            imageInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleRewriterImageFile(e.target.files[0]);
                }
            });

            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-purple-500', 'bg-gray-800/50');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-purple-500', 'bg-gray-800/50');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleRewriterImageFile(e.dataTransfer.files[0]);
                }
            });

            // Clear button
            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                clearRewriterImagePreview();
                imageInput.value = '';
            });
        }

        // Handle rewriter image file upload
        function handleRewriterImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                rewriterImageBase64 = e.target.result;

                // Show preview
                const dropzoneContent = document.getElementById('rewriterDropzoneContent');
                const imagePreview = document.getElementById('rewriterImagePreview');
                const previewImg = document.getElementById('rewriterPreviewImg');

                dropzoneContent.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                previewImg.src = rewriterImageBase64;
            };
            reader.readAsDataURL(file);
        }

        // Initialize rewriter image upload
        setupRewriterImageUpload();

        rewriteBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('prompt').value.trim();
            const rewriter = document.getElementById('rewriterTemplate').value;
            const customPrompt = document.getElementById('customRewriterPrompt').value.trim();
            const maxTokens = parseInt(document.getElementById('rewriterMaxTokens').value) || 512;
            const temperature = parseFloat(document.getElementById('rewriterTemperature').value) || 0.6;
            const topP = parseFloat(document.getElementById('rewriterTopP').value) || 0.95;
            const topK = parseInt(document.getElementById('rewriterTopK').value) || 20;
            const minP = parseFloat(document.getElementById('rewriterMinP').value) || 0.0;
            const presencePenalty = parseFloat(document.getElementById('rewriterPresencePenalty').value) || 0.0;
            const selectedModel = document.getElementById('rewriterModel').value;
            const isVLModel = selectedModel === 'qwen3-vl' || selectedModel === 'qwen3-vl-api';

            // Validate: need prompt OR image (VL only)
            if (!prompt && !(isVLModel && rewriterImageBase64)) {
                alert(isVLModel ? 'Please enter a prompt or upload an image' : 'Please enter a prompt first');
                return;
            }

            // Validate based on mode
            if (rewriterMode === 'template' && !rewriter) {
                alert('Please select a rewriter style');
                return;
            }
            if (rewriterMode === 'custom' && !customPrompt) {
                alert('Please enter custom rewriting instructions');
                return;
            }

            // Show status
            rewriteBtn.disabled = true;
            rewriteStatus.classList.remove('hidden');
            rewrittenResult.classList.add('hidden');

            try {
                // Build request based on mode
                const requestBody = {
                    prompt: prompt || null,
                    model: selectedModel,
                    max_tokens: maxTokens,
                    temperature,
                    top_p: topP,
                    top_k: topK,
                    min_p: minP,
                    presence_penalty: presencePenalty,
                };

                // Add image if using VL model
                if (isVLModel && rewriterImageBase64) {
                    requestBody.image = rewriterImageBase64;
                }

                if (rewriterMode === 'template') {
                    requestBody.rewriter = rewriter;
                } else {
                    requestBody.custom_system_prompt = customPrompt;
                }

                const response = await fetch(`${API_BASE}/api/rewrite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Rewrite failed');
                }

                const data = await response.json();
                lastRewrittenPrompt = data.rewritten_prompt;
                lastThinkingContent = data.thinking_content || null;
                rewrittenText.textContent = data.rewritten_prompt;
                const modeLabel = rewriterMode === 'custom' ? 'custom prompt' : data.rewriter;
                // Model label: use returned model name, with fallback mapping for known models
                let modelLabel = data.model;
                if (data.model === 'qwen3-vl') modelLabel = 'Qwen3-VL (local)';
                else if (data.model === 'qwen3-4b') modelLabel = 'Qwen3-4B';
                let infoText = `Generated in ${data.gen_time.toFixed(2)}s using ${modelLabel}`;
                if (modeLabel) {
                    infoText += ` + ${modeLabel}`;
                }
                if (lastThinkingContent) {
                    infoText += ` (thinking: ${lastThinkingContent.length} chars)`;
                }
                rewriteInfo.textContent = infoText;
                rewrittenResult.classList.remove('hidden');

                // Show/hide extracted thinking content
                const extractedThinkingResult = document.getElementById('extractedThinkingResult');
                const extractedThinkingText = document.getElementById('extractedThinkingText');
                if (lastThinkingContent) {
                    extractedThinkingText.textContent = lastThinkingContent;
                    extractedThinkingResult.classList.remove('hidden');
                } else {
                    extractedThinkingResult.classList.add('hidden');
                }

            } catch (err) {
                alert('Rewrite failed: ' + err.message);
            } finally {
                rewriteBtn.disabled = false;
                rewriteStatus.classList.add('hidden');
            }
        });

        // Use rewritten prompt
        useRewrittenBtn.addEventListener('click', () => {
            if (lastRewrittenPrompt) {
                document.getElementById('prompt').value = lastRewrittenPrompt;
                // If thinking content was extracted, set it in the thinking field
                if (lastThinkingContent) {
                    document.getElementById('thinkingContent').value = lastThinkingContent;
                }
                // Collapse the rewriter section
                document.getElementById('rewriterSection').removeAttribute('open');
                // Scroll to prompt
                document.getElementById('prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('prompt').focus();
            }
        });

        // Copy rewritten prompt
        copyRewrittenBtn.addEventListener('click', async () => {
            if (lastRewrittenPrompt) {
                try {
                    await navigator.clipboard.writeText(lastRewrittenPrompt);
                    const originalText = copyRewrittenBtn.textContent;
                    copyRewrittenBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyRewrittenBtn.textContent = originalText;
                    }, 1500);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            }
        });

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/history`);
                const data = await response.json();
                renderHistory(data.history);
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        // Render history
        function renderHistory(history) {
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">No generations yet</div>';
                return;
            }

            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item relative rounded-lg overflow-hidden mb-2 cursor-pointer group" data-index="${index}">
                    <img src="data:image/png;base64,${item.image_b64}" class="w-full aspect-square object-cover" alt="Generated">
                    <div class="history-overlay absolute inset-0 bg-black/60 opacity-0 flex flex-col justify-end p-2">
                        <p class="text-white text-xs line-clamp-2 mb-1">${escapeHtml(item.prompt.substring(0, 80))}${item.prompt.length > 80 ? '...' : ''}</p>
                        <div class="flex gap-1">
                            <button class="history-reuse flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors">
                                Use
                            </button>
                            <button class="history-delete px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors">
                                X
                            </button>
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 text-xs text-white/70 bg-black/50 px-1 rounded">
                        ${item.width}x${item.height}
                    </div>
                </div>
            `).join('');

            // Add event listeners
            historyList.querySelectorAll('.history-reuse').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    reuseHistoryItem(history[index]);
                });
            });

            historyList.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.closest('.history-item').dataset.index);
                    await deleteHistoryItem(index);
                });
            });

            historyList.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    showHistoryItemFull(history[index]);
                });
            });
        }

        // Reuse history item
        function reuseHistoryItem(item) {
            document.getElementById('prompt').value = item.prompt;
            document.getElementById('systemPrompt').value = item.system_prompt || '';
            document.getElementById('thinkingContent').value = item.thinking_content || '';
            document.getElementById('assistantContent').value = item.assistant_content || '';
            document.getElementById('enableThinking').checked = item.force_think_block || false;
            document.getElementById('stripQuotes').checked = item.strip_quotes || false;
            updateThinkingContentVisibility();
            document.getElementById('seed').value = item.seed || '';
            document.getElementById('template').value = item.template || '';

            // Set steps
            stepsSlider.value = item.steps || 9;
            stepsValue.textContent = stepsSlider.value;

            // Set guidance_scale and shift if they exist
            if (item.guidance_scale !== undefined) {
                guidanceScaleSlider.value = item.guidance_scale;
                guidanceScaleValue.textContent = parseFloat(item.guidance_scale).toFixed(1);
            }
            if (item.shift !== undefined) {
                shiftSlider.value = item.shift;
                shiftValue.textContent = parseFloat(item.shift).toFixed(1);
            }
            if (item.long_prompt_mode) {
                longPromptModeSelect.value = item.long_prompt_mode;
            }
            if (item.hidden_layer !== undefined) {
                hiddenLayerSlider.value = item.hidden_layer;
                updateHiddenLayerUI(item.hidden_layer);
            }

            // Set resolution
            const resValue = `${item.width}x${item.height}`;
            const resOption = [...resolutionSelect.options].find(o => o.value === resValue);
            if (resOption) {
                resolutionSelect.value = resValue;
                customResolution.classList.add('hidden');
            } else {
                resolutionSelect.value = 'custom';
                customResolution.classList.remove('hidden');
                widthSelect.value = item.width;
                heightSelect.value = item.height;
            }

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }

            // Scroll to top and focus prompt
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('prompt').focus();
        }

        // Show full history item in result area
        function showHistoryItemFull(item) {
            resultImage.src = `data:image/png;base64,${item.image_b64}`;
            downloadBtn.href = `data:image/png;base64,${item.image_b64}`;

            let infoText = `${item.width}x${item.height}, ${item.steps} steps, ${item.gen_time.toFixed(1)}s`;
            if (item.guidance_scale !== undefined && item.guidance_scale !== 0) {
                infoText += `, CFG ${item.guidance_scale}`;
            }
            if (item.shift !== undefined && item.shift !== 3.0) {
                infoText += `, shift ${item.shift}`;
            }
            if (item.long_prompt_mode && item.long_prompt_mode !== 'truncate') {
                infoText += `, ${item.long_prompt_mode}`;
            }
            if (item.hidden_layer !== undefined && item.hidden_layer !== -2) {
                infoText += `, layer ${item.hidden_layer}`;
            }

            resultInfo.textContent = infoText;
            document.getElementById('resultFormattedPrompt').textContent = item.formatted_prompt || '-';

            currentParams = item;
            result.classList.remove('hidden');

            // Close history panel on mobile
            if (window.innerWidth < 768) {
                toggleHistoryPanel();
            }
        }

        // Delete history item
        async function deleteHistoryItem(index) {
            try {
                await fetch(`${API_BASE}/api/history/${index}`, { method: 'DELETE' });
                loadHistory();
            } catch (err) {
                console.error('Failed to delete:', err);
            }
        }

        // Clear all history
        clearHistoryBtn.addEventListener('click', async () => {
            if (confirm('Clear all history?')) {
                try {
                    await fetch(`${API_BASE}/api/history`, { method: 'DELETE' });
                    loadHistory();
                } catch (err) {
                    console.error('Failed to clear:', err);
                }
            }
        });

        // Reuse button
        reuseBtn.addEventListener('click', () => {
            if (currentParams) {
                reuseHistoryItem(currentParams);
            }
        });

        // Get current resolution
        function getResolution() {
            if (resolutionSelect.value === 'custom') {
                return {
                    width: parseInt(widthSelect.value),
                    height: parseInt(heightSelect.value)
                };
            }
            const [w, h] = resolutionSelect.value.split('x').map(Number);
            return { width: w, height: h };
        }

        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const { width, height } = getResolution();

            // Reset UI
            status.classList.remove('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
            generateBtn.disabled = true;
            progressFill.style.width = '10%';
            statusText.textContent = 'Starting...';

            const params = {
                prompt: document.getElementById('prompt').value,
                system_prompt: document.getElementById('systemPrompt').value || null,
                thinking_content: document.getElementById('thinkingContent').value || null,
                assistant_content: document.getElementById('assistantContent').value || null,
                force_think_block: document.getElementById('enableThinking').checked,
                strip_quotes: document.getElementById('stripQuotes').checked,
                template: document.getElementById('template').value || null,
                width,
                height,
                steps: parseInt(stepsSlider.value),
                seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
                guidance_scale: parseFloat(guidanceScaleSlider.value),
                shift: parseFloat(shiftSlider.value),
                long_prompt_mode: longPromptModeSelect.value,
                hidden_layer: parseInt(hiddenLayerSlider.value),
            };

            currentParams = params;

            // Check if VL conditioning is active
            const vlParams = typeof getVLParams === 'function' ? getVLParams() : {};
            const useVL = vlParams.vl_image || vlParams.vl_embeddings_id;

            try {
                progressFill.style.width = '20%';
                statusText.textContent = 'Formatting prompt...';

                // Get formatted prompt first (fast, no GPU)
                const formatResponse = await fetch(`${API_BASE}/api/format-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });
                let formattedPrompt = '-';
                if (formatResponse.ok) {
                    const formatData = await formatResponse.json();
                    formattedPrompt = formatData.formatted_prompt || '-';
                }

                progressFill.style.width = '30%';
                statusText.textContent = useVL ? 'Generating with VL conditioning...' : 'Generating...';

                // Use VL endpoint if VL conditioning is active
                const endpoint = useVL ? `${API_BASE}/api/vl/generate` : `${API_BASE}/api/generate`;
                const requestBody = useVL ? { ...params, ...vlParams } : params;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Generation failed');
                }

                progressFill.style.width = '70%';
                statusText.textContent = 'Processing...';

                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);

                const genTime = response.headers.get('X-Generation-Time');
                const seed = response.headers.get('X-Seed');

                resultImage.src = imageUrl;
                downloadBtn.href = imageUrl;

                let infoText = `${width}x${height}, ${params.steps} steps${genTime ? `, ${parseFloat(genTime).toFixed(1)}s` : ''}${seed && seed !== 'random' ? `, seed ${seed}` : ''}`;
                if (params.guidance_scale !== 0) {
                    infoText += `, CFG ${params.guidance_scale}`;
                }
                if (params.shift !== 3.0) {
                    infoText += `, shift ${params.shift}`;
                }
                if (params.long_prompt_mode && params.long_prompt_mode !== 'truncate') {
                    infoText += `, ${params.long_prompt_mode}`;
                }
                if (params.hidden_layer !== undefined && params.hidden_layer !== -2) {
                    infoText += `, layer ${params.hidden_layer}`;
                }
                // Add VL info if used
                if (useVL && vlParams.vl_alpha) {
                    infoText += `, VL ${vlParams.vl_alpha} (${vlParams.vl_blend_mode})`;
                }

                resultInfo.textContent = infoText;
                document.getElementById('resultFormattedPrompt').textContent = formattedPrompt;

                status.classList.add('hidden');
                result.classList.remove('hidden');
                progressFill.style.width = '100%';

                // Reload history
                loadHistory();

            } catch (err) {
                status.classList.add('hidden');
                error.classList.remove('hidden');
                errorText.textContent = err.message;
            } finally {
                generateBtn.disabled = false;
            }
        });

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Token count display with debouncing
        const tokenCountEl = document.getElementById('tokenCount');
        let tokenCountTimeout = null;

        async function updateTokenCount() {
            const prompt = document.getElementById('prompt').value;
            if (!prompt.trim()) {
                tokenCountEl.textContent = '-- / 1504 tokens';
                tokenCountEl.className = 'text-xs text-gray-400';
                return;
            }

            try {
                const params = {
                    prompt: prompt,
                    system_prompt: document.getElementById('systemPrompt').value || null,
                    thinking_content: document.getElementById('thinkingContent').value || null,
                    assistant_content: document.getElementById('assistantContent').value || null,
                    force_think_block: document.getElementById('enableThinking').checked,
                    template: document.getElementById('template').value || null,
                };

                const response = await fetch(`${API_BASE}/api/format-prompt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });

                if (response.ok) {
                    const data = await response.json();
                    const count = data.token_count;
                    const max = data.max_tokens || 1504;
                    const chars = data.char_count || 0;

                    if (count !== null) {
                        // Exact token count available (local encoder)
                        tokenCountEl.textContent = `${count} / ${max} tokens`;
                        if (count > max) {
                            tokenCountEl.className = 'text-xs text-red-400 font-medium';
                        } else if (count > max * 0.9) {
                            tokenCountEl.className = 'text-xs text-yellow-400';
                        } else {
                            tokenCountEl.className = 'text-xs text-green-400';
                        }
                    } else {
                        // No tokenizer (API backend) - show character estimate
                        // Rough estimate: ~3.5 chars per token for English text
                        const estTokens = Math.ceil(chars / 3.5);
                        tokenCountEl.textContent = `~${estTokens} tokens (est. from ${chars} chars)`;
                        if (estTokens > max) {
                            tokenCountEl.className = 'text-xs text-red-400 font-medium';
                        } else if (estTokens > max * 0.85) {
                            tokenCountEl.className = 'text-xs text-yellow-400';
                        } else {
                            tokenCountEl.className = 'text-xs text-gray-400';
                        }
                    }
                }
            } catch (err) {
                // Silently fail - token count is informational
                console.debug('Token count update failed:', err);
            }
        }

        function debouncedTokenCount() {
            if (tokenCountTimeout) clearTimeout(tokenCountTimeout);
            tokenCountTimeout = setTimeout(updateTokenCount, 500);
        }

        // Update token count on input changes
        document.getElementById('prompt').addEventListener('input', debouncedTokenCount);
        document.getElementById('systemPrompt').addEventListener('input', debouncedTokenCount);
        document.getElementById('thinkingContent').addEventListener('input', debouncedTokenCount);
        document.getElementById('assistantContent').addEventListener('input', debouncedTokenCount);
        document.getElementById('enableThinking').addEventListener('change', debouncedTokenCount);
        document.getElementById('template').addEventListener('change', debouncedTokenCount);

        // =====================================================================
        // Vision Conditioning (Qwen3-VL) Logic
        // =====================================================================

        // VL state
        let vlImageBase64 = null;
        let vlEmbeddingsId = null;
        let vlAvailable = false;

        // VL DOM elements
        const vlSection = document.getElementById('vlSection');
        const vlStatusBadge = document.getElementById('vlStatusBadge');
        const vlNotAvailable = document.getElementById('vlNotAvailable');
        const vlControls = document.getElementById('vlControls');
        const vlImageInput = document.getElementById('vlImageInput');
        const vlDropzone = document.getElementById('vlDropzone');
        const vlDropzoneContent = document.getElementById('vlDropzoneContent');
        const vlImagePreview = document.getElementById('vlImagePreview');
        const vlPreviewImg = document.getElementById('vlPreviewImg');
        const vlImageInfo = document.getElementById('vlImageInfo');
        const vlClearImageBtn = document.getElementById('vlClearImage');
        const vlAlphaSlider = document.getElementById('vlAlpha');
        const vlAlphaValue = document.getElementById('vlAlphaValue');
        const vlBlendMode = document.getElementById('vlBlendMode');
        const vlHiddenLayerSlider = document.getElementById('vlHiddenLayer');
        const vlHiddenLayerValue = document.getElementById('vlHiddenLayerValue');
        const vlImageTokensOnly = document.getElementById('vlImageTokensOnly');
        const vlText = document.getElementById('vlText');
        const vlExtractStatus = document.getElementById('vlExtractStatus');
        const vlExtractedInfo = document.getElementById('vlExtractedInfo');
        const vlExtractedDetails = document.getElementById('vlExtractedDetails');
        const vlClearEmbeddingsBtn = document.getElementById('vlClearEmbeddings');
        const vlPresetButtons = document.querySelectorAll('.vl-preset');

        // Check VL availability
        async function checkVLStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/vl/status`);
                const data = await response.json();

                vlAvailable = data.available;

                if (vlAvailable) {
                    vlStatusBadge.textContent = 'Available';
                    vlStatusBadge.classList.remove('bg-gray-700', 'text-gray-400', 'bg-yellow-700', 'text-yellow-300');
                    vlStatusBadge.classList.add('bg-green-700', 'text-green-300');
                    vlNotAvailable.classList.add('hidden');
                    vlControls.classList.remove('hidden');

                    // Load VL config defaults
                    const configResponse = await fetch(`${API_BASE}/api/vl/config`);
                    const config = await configResponse.json();
                    vlAlphaSlider.value = config.alpha;
                    vlAlphaValue.textContent = config.alpha;
                    vlHiddenLayerSlider.value = config.hidden_layer;
                    vlHiddenLayerValue.textContent = config.hidden_layer;
                    vlBlendMode.value = config.blend_mode || 'linear';

                    // Update preset buttons
                    updateVLPresetButtons(config.alpha);
                } else if (data.configured) {
                    vlStatusBadge.textContent = 'Not Loaded';
                    vlStatusBadge.classList.remove('bg-gray-700', 'text-gray-400', 'bg-green-700', 'text-green-300');
                    vlStatusBadge.classList.add('bg-yellow-700', 'text-yellow-300');
                    vlNotAvailable.classList.remove('hidden');
                    vlControls.classList.add('hidden');
                } else {
                    vlStatusBadge.textContent = 'Not Configured';
                    vlStatusBadge.classList.remove('bg-green-700', 'text-green-300', 'bg-yellow-700', 'text-yellow-300');
                    vlStatusBadge.classList.add('bg-gray-700', 'text-gray-400');
                    vlNotAvailable.classList.remove('hidden');
                    vlControls.classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to check VL status:', err);
                vlStatusBadge.textContent = 'Error';
                vlStatusBadge.classList.remove('bg-green-700', 'text-green-300', 'bg-gray-700', 'text-gray-400');
                vlStatusBadge.classList.add('bg-red-700', 'text-red-300');
            }
        }

        // Update VL preset buttons
        function updateVLPresetButtons(selectedAlpha) {
            vlPresetButtons.forEach(btn => {
                const alpha = parseFloat(btn.dataset.alpha);
                if (Math.abs(alpha - selectedAlpha) < 0.01) {
                    btn.classList.remove('bg-gray-700', 'text-gray-300');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                }
            });
        }

        // VL alpha slider
        vlAlphaSlider?.addEventListener('input', () => {
            vlAlphaValue.textContent = vlAlphaSlider.value;
            updateVLPresetButtons(parseFloat(vlAlphaSlider.value));
        });

        // VL preset buttons
        vlPresetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const alpha = parseFloat(btn.dataset.alpha);
                vlAlphaSlider.value = alpha;
                vlAlphaValue.textContent = alpha;
                updateVLPresetButtons(alpha);
            });
        });

        // VL hidden layer slider
        vlHiddenLayerSlider?.addEventListener('input', () => {
            vlHiddenLayerValue.textContent = vlHiddenLayerSlider.value;
        });

        // Image upload handling
        vlImageInput?.addEventListener('change', handleVLImageUpload);
        vlDropzone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            vlDropzone.classList.add('border-blue-500', 'bg-gray-800/50');
        });
        vlDropzone?.addEventListener('dragleave', () => {
            vlDropzone.classList.remove('border-blue-500', 'bg-gray-800/50');
        });
        vlDropzone?.addEventListener('drop', (e) => {
            e.preventDefault();
            vlDropzone.classList.remove('border-blue-500', 'bg-gray-800/50');
            if (e.dataTransfer.files.length > 0) {
                vlImageInput.files = e.dataTransfer.files;
                handleVLImageUpload({ target: vlImageInput });
            }
        });

        async function handleVLImageUpload(e) {
            const file = e.target.files?.[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const base64 = ev.target.result.split(',')[1];
                vlImageBase64 = base64;

                // Show preview
                vlPreviewImg.src = ev.target.result;
                vlDropzoneContent.classList.add('hidden');
                vlImagePreview.classList.remove('hidden');
                vlClearImageBtn.classList.remove('hidden');

                // Get image dimensions
                const img = new Image();
                img.onload = () => {
                    vlImageInfo.textContent = `${img.width}x${img.height} - ${(file.size / 1024).toFixed(1)} KB`;

                    // Warn if image is too large (will produce >1504 tokens)
                    const estimatedTokens = Math.ceil(img.width / 28) * Math.ceil(img.height / 28);
                    if (estimatedTokens > 1504) {
                        vlImageInfo.textContent += ` (Warning: ~${estimatedTokens} tokens, may exceed limit)`;
                        vlImageInfo.classList.add('text-yellow-400');
                    } else {
                        vlImageInfo.classList.remove('text-yellow-400');
                    }
                };
                img.src = ev.target.result;

                // Clear any existing embeddings
                vlEmbeddingsId = null;
                vlExtractedInfo.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Clear image
        vlClearImageBtn?.addEventListener('click', () => {
            vlImageBase64 = null;
            vlEmbeddingsId = null;
            vlImageInput.value = '';
            vlDropzoneContent.classList.remove('hidden');
            vlImagePreview.classList.add('hidden');
            vlClearImageBtn.classList.add('hidden');
            vlExtractedInfo.classList.add('hidden');
        });

        // Clear embeddings
        vlClearEmbeddingsBtn?.addEventListener('click', async () => {
            if (vlEmbeddingsId) {
                try {
                    await fetch(`${API_BASE}/api/vl/cache/${vlEmbeddingsId}`, { method: 'DELETE' });
                } catch (err) {
                    console.error('Failed to clear embeddings:', err);
                }
            }
            vlEmbeddingsId = null;
            vlExtractedInfo.classList.add('hidden');
        });

        // Extract VL embeddings (for pre-extraction workflow)
        async function extractVLEmbeddings() {
            if (!vlImageBase64) return null;

            vlExtractStatus.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/vl/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: vlImageBase64,
                        text: vlText.value || null,
                        hidden_layer: parseInt(vlHiddenLayerSlider.value),
                        image_tokens_only: vlImageTokensOnly.checked,
                        scale_to_text: true,
                    }),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Extraction failed');
                }

                const result = await response.json();
                vlEmbeddingsId = result.embeddings_id;

                vlExtractedDetails.textContent = `${result.num_tokens} tokens, layer ${result.hidden_layer}, ${result.extract_time.toFixed(2)}s`;
                vlExtractedInfo.classList.remove('hidden');

                return vlEmbeddingsId;
            } catch (err) {
                console.error('VL extraction failed:', err);
                throw err;
            } finally {
                vlExtractStatus.classList.add('hidden');
            }
        }

        // Get VL parameters for generation request
        function getVLParams() {
            if (!vlAvailable || (!vlImageBase64 && !vlEmbeddingsId)) {
                return {};
            }

            return {
                vl_image: vlEmbeddingsId ? null : vlImageBase64,
                vl_embeddings_id: vlEmbeddingsId || null,
                vl_alpha: parseFloat(vlAlphaSlider.value),
                vl_hidden_layer: parseInt(vlHiddenLayerSlider.value),
                vl_image_tokens_only: vlImageTokensOnly.checked,
                vl_text: vlText.value || null,
                vl_blend_mode: vlBlendMode.value,
            };
        }

        // =====================================================================
        // End Vision Conditioning Logic
        // =====================================================================

        // Initialize
        loadTemplates();
        loadRewriters();
        loadRewriterModels();
        loadHistory();
        checkVLStatus();
    </script>
</body>
</html>
